<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã¤ã¿ãƒ­ã‚°ï¼ˆå…¥åŠ›ï¼‰</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YY44S858BX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}

  // åˆæœŸåŒ–
  gtag('js', new Date());

  // è¨­å®šï¼ˆå¿…è¦ãªã‚‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ ï¼‰
  gtag('config', 'G-YY44S858BX', {
    // ä¾‹ï¼šé–‹ç™ºä¸­ã ã‘ãƒ‡ãƒãƒƒã‚°ã—ãŸã„å ´åˆ
    // debug_mode: true
  });
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Old+Mincho:wght@600&family=Shippori+Mincho:wght@400;600&display=swap" rel="stylesheet">

<style>
  /* =========================
    1) ãƒ†ãƒ¼ãƒå¤‰æ•°ï¼ˆè¦‹ãŸç›®ã®æ ¹ã£ã“ï¼‰
    - JSã§ localStorage ã®å€¤ã‚’èª­ã¿å–ã‚Šã€ã“ã“ã‚’æ›¸ãæ›ãˆã‚‹
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ†ãƒ¼ãƒç”»é¢ã‹ã‚‰å¤‰ãˆã‚‰ã‚Œã‚‹
  ========================= */
  :root{
    /* èƒŒæ™¯ï¼ˆå…‰ + ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
    --bg1: rgba(14,165,233,.13);     /* å…‰â‘  */
    --bg2: rgba(34,197,94,.10);      /* å…‰â‘¡ */
    --bgTop: #f7fbff;               /* èƒŒæ™¯ä¸Š */
    --bgBottom: #f7fff9;            /* èƒŒæ™¯ä¸‹ */

    /* æ–‡å­— */
    --text:#1f2937;
    --muted:#6b7280;

    /* ã‚«ãƒ¼ãƒ‰ */
    --card: rgba(255,255,255,.80);
    --stroke: rgba(31,41,55,.14);

    /* ãƒœã‚¿ãƒ³/ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
    --accent:#ff7a2f;
    --accent2:#ffd2a8;

    /* çŠ¶æ…‹è‰² */
    --danger:#d83a3a;
    --ok:#1d8f5a;

    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå›ºå®šï¼‰ */
    --shadow: 0 14px 38px rgba(0,0,0,.08);
    --r:18px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI","Hiragino Sans","Noto Sans JP",sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 600px at 18% 6%, var(--bg1), transparent 60%),
      radial-gradient(900px 700px at 85% 15%, var(--bg2), transparent 60%),
      linear-gradient(180deg, var(--bgTop), var(--bgBottom));
    min-height:100vh;
  }

  header{
    padding:18px 16px 10px;
    max-width:1100px;
    margin:0 auto;
    display:flex;
    gap:12px;
    align-items:flex-end;
    justify-content:space-between;
  }
  .title{font-weight:900;font-size:20px;letter-spacing:.02em}
  .rightHead{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  .chip{
    font-size:12px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,.08);
    background:#fff;
    color:var(--muted);
    white-space:nowrap;
  }
  .chipBtn{
    font:inherit;
    cursor:pointer;
  }

  .wrap{
    max-width:1100px;
    margin:0 auto;
    padding:0 16px 22px;
    display:grid;
    grid-template-columns: 420px 1fr;
    gap:14px;
  }
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr} }

  .card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    backdrop-filter: blur(8px);
  }
  .card h2{
    font-size:14px;margin:0;padding:14px 14px 10px;
    border-bottom:1px solid rgba(0,0,0,.06);
    display:flex;align-items:center;justify-content:space-between;gap:10px
  }

  form{padding:12px 14px 14px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input,select,textarea{
    width:100%;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
    color:var(--text);
    outline:none;
  }
  textarea{
    min-height:140px;
    resize:vertical;
    line-height:1.6;
  }
  .full{grid-column:1/-1}

  .btns{display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap}
  button{border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
  .primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
  .ghost{background:#fff;border:1px solid rgba(0,0,0,.12);color:var(--text)}
  .danger{background:#fff;border:1px solid rgba(216,58,58,.35);color:var(--danger)}
  .hint{font-size:12px;color:var(--muted);margin-left:auto}

  /* stats */
  .stats{padding:14px}
  .statsTop{
    display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:10px
  }
  .statsTitle{font-size:18px;margin:0}
  .meta{color:var(--muted);font-size:12px;margin-top:6px}
  .statsControls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .statsControls select{padding:6px 10px;border-radius:999px;font-size:12px}
  .box{background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:10px}
  .cap{font-size:12px;color:var(--muted);margin-bottom:6px}
  .body{font-size:14px;font-weight:900}
  .mini{color:var(--muted);font-size:12px}

  /* recent */
  .recent{padding:10px 14px 14px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  td{background:#fff;border:1px solid rgba(0,0,0,.08);padding:10px;font-size:13px;vertical-align:top}
  td:first-child{border-radius:12px 0 0 12px}
  td:last-child{border-radius:0 12px 12px 0}
  .linklike{color:var(--accent);text-decoration:underline;cursor:pointer;font-weight:900}
  .empty{color:var(--muted);padding:10px 0;font-size:13px}

  /* =========================
    ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šï¼ˆãƒ†ãƒ¼ãƒ/ãƒ˜ãƒ«ãƒ—ï¼‰
  ========================= */
  .modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.35);
    padding:16px;
    z-index:999;
    align-items:center;
    justify-content:center;
  }
  .modal .inner{
    max-width:680px;
    width:100%;
    padding:14px;
    max-height: calc(100vh - 32px);
    overflow:auto;
  }
  .modalTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .modalBody{
    overflow:visible;
    padding-right:4px; 
  }
  .modalTitle{
    margin:0;
    font-size:16px;
    font-weight:900;
  }

/* =========================
   è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å°‚ç”¨ï¼ˆindexå´ï¼‰
========================= */

  #detailModal{
    align-items: flex-start;
    justify-content: center;
  }

  #detailModal .inner{
    width: min(720px, calc(100vw - 32px));
    height: min(75vh, calc(100vh - 32px));
    margin: 24px 0 0;

    display: flex;
    flex-direction: column;

    overflow: hidden;
  }

  #detailModal .helpBox{
    flex: 1;
    overflow: auto;
    min-height: 0;
  }

  /* ãƒ†ãƒ¼ãƒUI */
  .presetBar{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .presetBtn{
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
    border-radius:999px;
    padding:8px 10px;
    cursor:pointer;
    font-weight:900;
    font-size:12px;
  }
  /* âœ… é¸æŠä¸­ã®ãƒ—ãƒªã‚»ãƒƒãƒˆãŒåˆ†ã‹ã‚‹ */
  .presetBtn.active{
    border-color: rgba(255,122,47,.55);
    box-shadow: 0 0 0 3px rgba(255,122,47,.18);
  }

  .themeGrid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  .themeGrid input[type="color"]{
    padding:0;
    height:42px;
    border-radius:12px;
    border:1px solid rgba(0,0,0,.12);
    background:#fff;
  }
  .themeGrid input[type="text"]{
    font-size:12px;
  }
  .note{
    margin:8px 0 0;
    color:var(--muted);
    font-size:12px;
    line-height:1.5;
  }

  /* å…±æœ‰UIï¼ˆJSONï¼‰ */
  .shareRow{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .shareBox{
    width:100%;
    min-height:120px;
    margin-top:8px;
  }

  /* ãƒ˜ãƒ«ãƒ— */
  .helpBox{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
    padding:12px;
    line-height:1.7;
    font-size:14px;
  }
  .helpBox h4{
    margin:0 0 6px;
    font-size:14px;
  }
  .helpBox ul{
    margin:6px 0 0 18px;
    padding:0;
  }

  /* =========================
   ãƒ¢ãƒã‚¤ãƒ«æœ€å°å¯¾å¿œï¼ˆè¿½åŠ ã™ã‚‹ã ã‘ï¼‰
  ========================= */
@media (max-width: 520px){
  /* å…¨ä½“ */
  header{
    padding:14px 12px 8px;
  }
  .wrap{
    padding:0 12px 18px;
    gap:12px;
  }

  /* å³ä¸Šãƒãƒƒãƒ—ãŒè©°ã¾ã‚Šã‚„ã™ã„ã®ã§å°‘ã—å°ã•ã */
  .chip{
    font-size:11px;
    padding:4px 8px;
  }

  /* å…¥åŠ›ã‚¨ãƒªã‚¢ï¼š2åˆ—â†’1åˆ— */
  .grid{
    grid-template-columns:1fr;
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç”»é¢ã„ã£ã±ã„å¯„ã‚Šã«ã—ã¦æ‰±ã„ã‚„ã™ã */
  .modal{
    padding:10px;
  }
  .modal .inner{
    max-height: 92vh;
    padding:12px;
  }

  /* ãƒ†ãƒ¼ãƒã®2åˆ—â†’1åˆ—ï¼ˆã‚¹ãƒãƒ›ã§æœ€é‡è¦ï¼‰ */
  .themeGrid{
    grid-template-columns:1fr;
  }

  /* å…±æœ‰ãƒœã‚¿ãƒ³ã‚’ç¸¦ä¸¦ã³ã« */
  .shareRow{
    flex-direction:column;
  }
  .shareRow button{
    width:100%;
  }

  /* JSONæ¬„ï¼šå°‘ã—é«˜ã‚ã«ã—ã¦è²¼ã‚Šä»˜ã‘ã‚„ã™ã */
  .shareBox{
    min-height: 180px;
  }

  /* ç›´è¿‘5ä»¶ã®è¡¨ï¼šæ¨ªå¹…ãŒãã¤ã„ã®ã§å°‘ã—èª¿æ•´ */
  table{ border-spacing:0 6px; }
  td{ padding:8px; font-size:12px; }
}

  /* â–¼ ãƒãƒ¼ã‚¸ãƒ§ãƒ³å³ä¸‹è¡¨ç¤º */
  .versionBadge{
    position: fixed;
    right: 16px;
    bottom: 16px;
    font-size: 12px;
    opacity: 0.6;
    background: rgba(0,0,0,0.05);
    padding: 6px 10px;
    border-radius: 12px;
    backdrop-filter: blur(4px);
    z-index: 999;
    transition: opacity 0.2s ease;
  }

  .versionBadge:hover{
    opacity: 1;
  }
</style>
</head>

<body>
<header>
  <div class="title">ğŸŒ± ã¤ã¿ãƒ­ã‚°</div>
  <div class="rightHead">
    <!-- ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸ -->
    <a class="chip" href="list.html" style="text-decoration:none;color:inherit;">ä¸€è¦§ã‚’è¦‹ã‚‹ â†’</a>

    <!-- ãƒ˜ãƒ«ãƒ— -->
    <button class="chip chipBtn" id="openHelp" type="button">â“ ãƒ˜ãƒ«ãƒ—</button>

    <!-- ãƒ†ãƒ¼ãƒï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆï¼‹è‡ªç”±å¤‰æ›´ï¼‰ -->
    <button class="chip chipBtn" id="openTheme" type="button">ğŸ¨ ãƒ†ãƒ¼ãƒ</button>

    <!-- ã¡ã‚‡ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="chip" title="ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚">ğŸ”’ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</div>
    <div class="chip" id="todayRateChip">ä»Šæ—¥ï¼š0å‹0æ•—</div>
    <div class="chip" id="countChip">0ä»¶</div>
  </div>
</header>

<!-- å…¥åŠ›ã‚¾ãƒ¼ãƒ³ -->
<div class="wrap">
  <section class="card">
    <h2>
      <span>å…¥åŠ›</span>
      <span class="chip" id="nowChip">â€”</span>
    </h2>

    <form id="f">
      <div class="grid">
        <div class="row">
          <label>ç›¸æ‰‹ï¼ˆä»»æ„ï¼‰</label>
          <input id="opponent" placeholder="ä¾‹ï¼šâ—‹â—‹ã•ã‚“" />
        </div>

        <div class="row">
          <label>å‹æ•—</label>
          <select id="result" required>
            <option value="WIN">å‹ã¡</option>
            <option value="LOSE">è² ã‘</option>
          </select>
        </div>

        <div class="row">
          <label>è‡ªåˆ†ãƒ¡ã‚¬ãƒŸï¼ˆä½¿ç”¨ï¼‰</label>
          <input id="my1" list="wordList" placeholder="ä¾‹ï¼šãƒ¦ãƒªãƒŠ" required />
          <input id="my2" list="wordList" placeholder="ä¾‹ï¼šã‚µã‚¤ãƒ" required />
        </div>

        <div class="row">
          <label>ç›¸æ‰‹ãƒ¡ã‚¬ãƒŸï¼ˆä½¿ç”¨ï¼‰</label>
          <input id="their1" list="wordList" placeholder="ä¾‹ï¼šãƒ’ãƒŸã‚«" required />
          <input id="their2" list="wordList" placeholder="ä¾‹ï¼šãƒˆã‚³ãƒ¨" required />
        </div>

        <div class="row">
          <label>BANã•ã‚ŒãŸãƒ¡ã‚¬ãƒŸ</label>
          <input id="myBan" list="wordList" placeholder="ä¾‹ï¼šã‚ªãƒœãƒ­" />
        </div>

        <div class="row">
          <label>BANã—ãŸãƒ¡ã‚¬ãƒŸ</label>
          <input id="theirBan" list="wordList" placeholder="ä¾‹ï¼šãƒ¦ã‚­ãƒ’" />
        </div>

        <div class="row">
          <label>å…ˆå¾Œï¼ˆä»»æ„ï¼‰</label>
          <select id="turn">
            <option value="">â€”</option>
            <option value="å…ˆæ‰‹">å…ˆæ‰‹</option>
            <option value="å¾Œæ‰‹">å¾Œæ‰‹</option>
          </select>
        </div>

        <div class="row">
          <label>å¯¾æˆ¦åŒºåˆ†ï¼ˆä»»æ„ï¼‰</label>
          <select id="matchType">
            <option value="">â€”</option>
            <option value="tournament">å¤§ä¼š</option>
            <option value="free">ãƒ•ãƒªãƒ—</option>
            <option value="rank">ãƒ©ãƒ³ã‚¯</option>
          </select>
        </div>

        <div class="row">
          <label>ãƒ¡ãƒ¢çŸ­ç¸®ï¼ˆä»»æ„ï¼‰</label>
          <input id="tag" placeholder="ä¾‹ï¼šãƒªãƒ¼ã‚µãƒ«æ€¥ã / é–“åˆãƒŸã‚¹" />
        </div>

        <div class="row full">
          <label>åçœç‚¹ï¼ˆä»»æ„ãƒ»è¤‡æ•°è¡ŒOKï¼‰</label>
          <textarea id="pivot" placeholder="ä¾‹ï¼šç¬¬3ã‚¿ãƒ¼ãƒ³ã€å‰é€²ã›ãšã«é–“åˆ2ç¶­æŒã™ã¹ãã ã£ãŸ"></textarea>
        </div>

        <div class="row full">
          <label>æ”¹å–„ç‚¹ï¼ˆä»»æ„ãƒ»è¤‡æ•°è¡ŒOKï¼‰</label>
          <textarea id="next" placeholder="ä¾‹ï¼šãƒªãƒ¼ã‚µãƒ«å‰ã«æŒ‡å·®ã—ç¢ºèªï¼‹è¨ˆç®—ã—ã¦ã‹ã‚‰å®£è¨€"></textarea>
        </div>
      </div>

      <div class="btns">
        <button class="primary" type="submit">ä¿å­˜</button>
        <button class="ghost" type="button" id="clearForm">å…¥åŠ›ã‚¯ãƒªã‚¢</button>
        <button class="danger" type="button" id="wipeAll">å…¨æ¶ˆã—</button>
        <span class="hint">â€»ä¿å­˜ã¯ã“ã®PCã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ã™</span>
      </div>
      
      <!-- ãƒ¡ã‚¬ãƒŸ/BAN å…±é€šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¾æ›¸ï¼ˆå€™è£œï¼‰ -->
      <datalist id="wordList"></datalist>
    </form>
  </section>

  <!-- å‹ç‡ã‚¾ãƒ¼ãƒ³ -->
  <section style="display:flex;flex-direction:column;gap:14px;">
    <section class="card stats" id="statsCard">
      <div class="statsTop">
        <div>
          <h3 class="statsTitle">å‹ç‡</h3>
          <div class="meta" id="statsMeta">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
        <div class="statsControls">
          <span class="chip" id="todayChip">ä»Šæ—¥ï¼š0å‹0æ•—</span>
     
          <!-- âœ… åŒºåˆ†ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå‹ç‡ã®å¯¾è±¡ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼‰ -->
          <select id="typeSelect" aria-label="åŒºåˆ†ã‚’é¸æŠ">
            <option value="ALL">åŒºåˆ†ï¼šãªã—ï¼ˆå…¨éƒ¨ï¼‰</option>
            <option value="tournament">åŒºåˆ†ï¼šå¤§ä¼š</option>
            <option value="free">åŒºåˆ†ï¼šãƒ•ãƒªãƒ—</option>
            <option value="rank">åŒºåˆ†ï¼šãƒ©ãƒ³ã‚¯</option>
          </select>

          <select id="yearSelect" aria-label="å¹´ã‚’é¸æŠ"></select>
        </div>
      </div>

      <div class="textBlock">
        <div class="box">
          <div class="cap">ä»Šæ—¥ã®å‹ç‡</div>
          <div class="body" id="rateToday">â€”</div>
          <div class="mini" id="rateTodayMeta"></div>
        </div>

        <div class="box">
          <div class="cap">é¸æŠã—ãŸå¹´ï¼ˆ1æœˆã€œ12æœˆï¼‰ã®å‹ç‡</div>
          <div class="body" id="rateYear">â€”</div>
          <div class="mini" id="rateYearMeta"></div>
        </div>

        <div class="box">
          <div class="cap">å…¨ä½“ã®å‹ç‡</div>
          <div class="body" id="rateAll">â€”</div>
          <div class="mini" id="rateAllMeta"></div>
        </div>
      </div>
    </section>

    <section class="card recent">
      <h2>
        <span>ç›´è¿‘6ä»¶</span>
        <a class="chip" href="list.html" style="text-decoration:none;color:inherit;">ä¸€è¦§ã¸</a>
      </h2>
      <div id="recentArea"></div>
    </section>
  </section>
</div>

<!-- =========================
  ãƒ†ãƒ¼ãƒãƒ¢ãƒ¼ãƒ€ãƒ«
  - ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼‰
  - æ‰‹å‹•èª¿æ•´ï¼ˆè‰²ãƒ”ãƒƒã‚«ãƒ¼ + bg1/bg2ã¯æ–‡å­—ã§è‡ªç”±å…¥åŠ›ï¼‰
  - å…±æœ‰ï¼ˆJSONï¼‰
  - ãƒã‚¤ãƒ†ãƒ¼ãƒï¼ˆåå‰ã‚’ã¤ã‘ã¦ä¿å­˜ï¼‰
========================= -->
<div id="themeModal" class="modal" aria-hidden="true">
  <div class="card inner">
    <div class="modalTop">
      <h3 class="modalTitle">ğŸ¨ ãƒ†ãƒ¼ãƒè¨­å®š</h3>
      <button class="ghost" type="button" id="closeTheme">é–‰ã˜ã‚‹</button>
    </div>

    <div class="modalBody">
    <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆJSã§ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆï¼‰ -->
    <div class="presetBar" id="presetBar"></div>

    <!-- ãƒã‚¤ãƒ†ãƒ¼ãƒä¿å­˜ -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0;">
      <input id="myThemeName" type="text" placeholder="ãƒã‚¤ãƒ†ãƒ¼ãƒåï¼ˆä¾‹ï¼šå¤œãµã‹ã—ãƒ–ãƒ«ãƒ¼ï¼‰"
             style="flex:1;min-width:220px;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.12);">
      <button class="ghost" type="button" id="saveMyThemeBtn">ï¼‹ åå‰ã‚’ã¤ã‘ã¦ä¿å­˜</button>
    </div>

    <div class="mini" style="margin:0 0 10px;">
      â€»ä¿å­˜ã—ãŸãƒ†ãƒ¼ãƒã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«è¿½åŠ ã•ã‚Œã€ä¸Šã®ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¾ã™
    </div>

    <!-- ç¾åœ¨ã®çŠ¶æ…‹ï¼ˆãƒ—ãƒªã‚»ãƒƒãƒˆå or ã‚«ã‚¹ã‚¿ãƒ ï¼‰ -->
    <div class="mini" id="themeCurrentLabel" style="margin:6px 0 10px;">ç¾åœ¨ï¼šâ€”</div>

    <div class="themeGrid">
      <div class="row">
        <label>ã‚¢ã‚¯ã‚»ãƒ³ãƒˆï¼ˆãƒœã‚¿ãƒ³ï¼‰</label>
        <input type="color" id="t_accent">
      </div>
      <div class="row">
        <label>ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ2ï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰</label>
        <input type="color" id="t_accent2">
      </div>

      <div class="row">
        <label>æ–‡å­—è‰²</label>
        <input type="color" id="t_text">
      </div>
      <div class="row">
        <label>ã‚µãƒ–æ–‡å­—</label>
        <input type="color" id="t_muted">
      </div>

      <div class="row">
        <label>èƒŒæ™¯ä¸Š</label>
        <input type="color" id="t_bgTop">
      </div>
      <div class="row">
        <label>èƒŒæ™¯ä¸‹</label>
        <input type="color" id="t_bgBottom">
      </div>

      <div class="row full">
        <label>èƒŒæ™¯ã®å…‰â‘ ï¼ˆCSSè‰²ï¼šrgba ãªã©ï¼‰</label>
        <input type="text" id="t_bg1" placeholder='ä¾‹ï¼šrgba(14,165,233,.13)'>
      </div>
      <div class="row full">
        <label>èƒŒæ™¯ã®å…‰â‘¡ï¼ˆCSSè‰²ï¼šrgba ãªã©ï¼‰</label>
        <input type="text" id="t_bg2" placeholder='ä¾‹ï¼šrgba(34,197,94,.10)'>
      </div>

      <div class="row">
        <label>ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ï¼ˆCSSè‰²ï¼‰</label>
        <input type="text" id="t_card" placeholder='ä¾‹ï¼šrgba(255,255,255,.80)'>
      </div>
      <div class="row">
        <label>æ ç·šï¼ˆCSSè‰²ï¼‰</label>
        <input type="text" id="t_stroke" placeholder='ä¾‹ï¼šrgba(31,41,55,.14)'>
      </div>
    </div>

    <p class="note">
      ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§ã‹ã‚‰å¾®èª¿æ•´ã‚‚OKã€‚è¨­å®šã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã€list.htmlã«ã‚‚åŒã˜ãƒ†ãƒ¼ãƒãŒåæ˜ ã•ã‚Œã¾ã™ã€‚
    </p>

    <div class="btns" style="margin-top:12px;">
      <button class="primary" type="button" id="applyThemeBtn">é©ç”¨</button>
      <button class="ghost" type="button" id="resetThemeBtn">åˆæœŸã«æˆ»ã™</button>
      <span class="hint">â€»é…å¸ƒã—ã¦ã‚‚å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å€‹åˆ¥ã«ä¿å­˜ã•ã‚Œã¾ã™</span>
    </div>

    <!-- å…±æœ‰ï¼šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
    <div class="shareRow">
      <button class="ghost" type="button" id="exportThemeBtn">ãƒ†ãƒ¼ãƒã‚’ã‚³ãƒ”ãƒ¼ï¼ˆJSONï¼‰</button>
      <button class="ghost" type="button" id="importThemeBtn">è²¼ã‚Šä»˜ã‘ã¦é©ç”¨</button>
    </div>
    <textarea id="themeJsonBox" class="shareBox" placeholder="ã“ã“ã«ãƒ†ãƒ¼ãƒJSONãŒå‡ºã¾ã™ / ã“ã“ã¸è²¼ã‚Šä»˜ã‘ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™"></textarea>
    <div class="mini" style="margin-top:6px;">â€»JSONã¯ã€Œè‰²è¨­å®šã®ã¿ã€ã§ã™ã€‚é…ä¿¡ã§åŒã˜é…è‰²ã«ã—ãŸã„äººå‘ã‘ã«å…±æœ‰ã§ãã¾ã™ã€‚</div>
    </div>
  </div>
</div>

<!-- =========================
  ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä½¿ã„æ–¹ï¼‰
========================= -->
<div id="helpModal" class="modal" aria-hidden="true">
  <div class="card inner">
    <div class="modalTop">
      <h3 class="modalTitle">â“ ä½¿ã„æ–¹</h3>
      <button class="ghost" type="button" id="closeHelp">é–‰ã˜ã‚‹</button>
    </div>

    <div class="helpBox">
      <h4>ã“ã®ãƒ„ãƒ¼ãƒ«ã§ã§ãã‚‹ã“ã¨</h4>
      <ul>
        <li>å¯¾æˆ¦ã®è¨˜éŒ²ã‚’ã€Œã“ã®PCã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã€ã«ä¿å­˜ã—ã¾ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼é€ä¿¡ãªã—ï¼‰ã€‚</li>
        <li>å‹ç‡ï¼ˆä»Šæ—¥ / å¹´ / å…¨ä½“ï¼‰ã‚’è‡ªå‹•ã§è¡¨ç¤ºã—ã¾ã™ã€‚</li>
        <li>ç›´è¿‘5ä»¶ã‚„ä¸€è¦§ã‹ã‚‰ã€è©¦åˆãƒ¡ãƒ¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚</li>
      </ul>
    </div>

    <div class="helpBox" style="margin-top:10px;">
      <h4>å…¥åŠ›ãƒšãƒ¼ã‚¸ï¼ˆindex.htmlï¼‰</h4>
      <ul>
        <li><b>å¿…é ˆ</b>ï¼šè‡ªåˆ†ãƒ¡ã‚¬ãƒŸ2ã¤ / ç›¸æ‰‹ãƒ¡ã‚¬ãƒŸ2ã¤</li>
        <li><b>ä»»æ„</b>ï¼šåçœç‚¹ãƒ»æ”¹å–„ç‚¹ï¼ˆè¤‡æ•°è¡ŒOKï¼‰</li>
        <li>ä¿å­˜ã™ã‚‹ã¨ãƒ•ã‚©ãƒ¼ãƒ ã¯è‡ªå‹•ã§ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚</li>
        <li>é–“é•ãˆã¦ä¿å­˜ã—ã¦ã—ã¾ã£ãŸå ´åˆã¯ã€ä¸€è¦§ã‹ã‚‰ç·¨é›†ã§ãã¾ã™ã€‚</li>
      </ul>
    </div>

    <div class="helpBox" style="margin-top:10px;">
      <h4>ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆlist.htmlï¼‰</h4>
      <ul>
        <li>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ»30ä»¶ã”ã¨ã®ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãŒã§ãã¾ã™ã€‚</li>
        <li>åçœç‚¹ã¯ä¸€è¦§ã§ã¯<b>1è¡Œç›®ã ã‘</b>è¡¨ç¤ºã—ã¾ã™ï¼ˆè¦‹ã‚„ã™ã•å„ªå…ˆï¼‰ã€‚</li>
        <li>è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®è©¦åˆã®å†…å®¹ã‚’å…¨æ–‡ã‚³ãƒ”ãƒ¼ã§ãã¾ã™ã€‚</li>
      </ul>
    </div>

    <div class="helpBox" style="margin-top:10px;">
      <h4>ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦</h4>
      <ul>
        <li>ä¿å­˜å ´æ‰€ï¼šãƒ–ãƒ©ã‚¦ã‚¶ã® localStorageï¼ˆåŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ãƒ»åŒã˜PCã§ã®ã¿è¦‹ãˆã¾ã™ï¼‰</li>
        <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒ»åˆæœŸåŒ–ã‚’ã™ã‚‹ã¨æ¶ˆãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</li>
        <li>ã€Œå…¨æ¶ˆã—ã€ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼ˆç¢ºèªãŒå‡ºã¾ã™ï¼‰ã€‚</li>
        <li>âš ï¸ ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å¤‰ãˆã‚‹ã¨å¼•ãç¶™ã’ã¾ã›ã‚“ã€‚</li>
      </ul>
    </div>

    <div class="helpBox" style="margin-top:10px;">
      <h4>ãƒ†ãƒ¼ãƒï¼ˆè¦‹ãŸç›®ï¼‰</h4>
      <ul>
        <li>ãƒ—ãƒªã‚»ãƒƒãƒˆã§ä¸€ç™ºå¤‰æ›´ã€è‰²ãƒ”ãƒƒã‚«ãƒ¼ã§å¾®èª¿æ•´ã‚‚ã§ãã¾ã™ã€‚</li>
        <li>ãƒ†ãƒ¼ãƒã‚‚ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã€list.htmlã«ã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚</li>
        <li>JSONã§ãƒ†ãƒ¼ãƒå…±æœ‰ï¼ˆã‚³ãƒ”ãƒ¼ï¼†è²¼ã‚Šä»˜ã‘ï¼‰ãŒã§ãã¾ã™ã€‚</li>
        <li>ã€Œåå‰ã‚’ã¤ã‘ã¦ä¿å­˜ã€ã§è‡ªåˆ†ç”¨ãƒ—ãƒªã‚»ãƒƒãƒˆãŒä½œã‚Œã¾ã™ã€‚</li>
      </ul>
    </div>
  </div>
</div>

<!-- =========================
  è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç›´è¿‘ã‚¯ãƒªãƒƒã‚¯ã§é–‹ãï¼‰
========================= -->
<div id="detailModal" class="modal" aria-hidden="true">
  <div class="card inner">
    <div class="modalTop">
      <h3 class="modalTitle">ï¼œè©¦åˆã®è©³ç´°ï¼</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <button class="ghost" type="button" id="closeDetail">é–‰ã˜ã‚‹</button>
      </div>
    </div>

    <div class="helpBox" style="background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:12px;">
      <div class="detailMeta" id="detailMeta" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;"></div>

      <div style="display:grid;gap:10px">
        <div>
          <div class="cap">åŸºæœ¬æƒ…å ±</div>
          <div class="pre" id="detailBase" style="white-space:pre-wrap;word-break:break-word;">â€”</div>
        </div>

        <div>
          <div class="cap">BAN</div>
          <div class="pre" id="detailBan" style="white-space:pre-wrap;word-break:break-word;">â€”</div>
        </div>

        <div>
          <div class="cap">åçœç‚¹</div>
          <div class="pre" id="detailPivot" style="white-space:pre-wrap;word-break:break-word;">â€”</div>
        </div>

        <div>
          <div class="cap">æ”¹å–„ç‚¹</div>
          <div class="pre" id="detailNext" style="white-space:pre-wrap;word-break:break-word;">â€”</div>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- â–¼ ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º -->
  <div class="versionBadge" id="versionBadge"></div>

<script>
(() => {
  // =========================================================
  // 0) DOMã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
  // =========================================================
  const $ = (id) => document.getElementById(id);
  
  //ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
  const APP_VERSION = "0.1.0";

  function track(name, params={}){
    // gtag æœªãƒ­ãƒ¼ãƒ‰ã§ã‚‚å£Šã‚Œãªã„ã‚ˆã†ã«
    if(typeof window.gtag === "function"){
      window.gtag("event", name, params);
    }
  }

  // =========================================================
  //  iPhone/Safariå¯¾ç­–
  // =========================================================
  async function copyText(text){
    // 1) ã¾ãšã¯ Clipboard APIï¼ˆhttps / ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªã“ã¨ãŒå¤šã„ï¼‰
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return { ok:true, via:"clipboard" };
      }
    }catch(e){
      // å¤±æ•—ã—ãŸã‚‰ä¸‹ã¸
    }

    // 2) ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼štextareaã«å…¥ã‚Œã¦é¸æŠâ†’execCommand('copy')
    try{
      const ta = document.createElement("textarea");
      ta.value = text;

      // ç”»é¢ã«è¦‹ãˆãªã„ã‚ˆã†ã«ã—ã¤ã¤ã€é¸æŠå¯èƒ½ã«ã™ã‚‹
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      ta.style.opacity = "0";
      ta.setAttribute("readonly", "");

      document.body.appendChild(ta);

      // iOSã¯ selectionRange æŒ‡å®šãŒåŠ¹ãã“ã¨ãŒå¤šã„
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);

      const ok = document.execCommand("copy");
      document.body.removeChild(ta);

      if(ok) return { ok:true, via:"execCommand" };
    }catch(e){
      // ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ä¸‹ã¸
    }

   // 3) æœ€çµ‚ï¼šã‚³ãƒ”ãƒ¼æ¬„ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¦‹ã›ã¦æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã—ã¦ã‚‚ã‚‰ã†
   showManualCopyModal(text);
   return { ok:false, via:"manual" };
  }

  // æ‰‹å‹•ã‚³ãƒ”ãƒ¼ç”¨ã®ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé•·æŠ¼ã—â†’ã‚³ãƒ”ãƒ¼ï¼‰
  function showManualCopyModal(text){
    // æ—¢ã«å‡ºã¦ãŸã‚‰å†åˆ©ç”¨
    let overlay = document.getElementById("manualCopyOverlay");
    let box = document.getElementById("manualCopyBox");

    if(!overlay){
      overlay = document.createElement("div");
      overlay.id = "manualCopyOverlay";
      overlay.style.position = "fixed";
      overlay.style.inset = "0";
      overlay.style.background = "rgba(0,0,0,.35)";
      overlay.style.zIndex = "2000";
      overlay.style.display = "flex";
      overlay.style.alignItems = "center";
      overlay.style.justifyContent = "center";
      overlay.style.padding = "14px";

      const card = document.createElement("div");
      card.style.maxWidth = "680px";
      card.style.width = "100%";
      card.style.background = "#fff";
      card.style.borderRadius = "16px";
      card.style.padding = "12px";
      card.style.boxShadow = "0 14px 38px rgba(0,0,0,.12)";

      const top = document.createElement("div");
      top.style.display = "flex";
      top.style.justifyContent = "space-between";
      top.style.alignItems = "center";
      top.style.gap = "10px";

      const title = document.createElement("div");
      title.textContent = "ã‚³ãƒ”ãƒ¼ã§ããªã‹ã£ãŸã®ã§æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ã­";
      title.style.fontWeight = "900";
      title.style.fontSize = "14px";

      const close = document.createElement("button");
      close.type = "button";
      close.textContent = "é–‰ã˜ã‚‹";
      close.style.border = "1px solid rgba(0,0,0,.15)";
      close.style.background = "#fff";
      close.style.borderRadius = "12px";
      close.style.padding = "8px 10px";
      close.style.cursor = "pointer";
      close.addEventListener("click", ()=> overlay.remove());

      top.appendChild(title);
      top.appendChild(close);

      box = document.createElement("textarea");
      box.id = "manualCopyBox";
      box.style.width = "100%";
      box.style.minHeight = "180px";
      box.style.marginTop = "10px";
      box.style.borderRadius = "12px";
      box.style.border = "1px solid rgba(0,0,0,.15)";
      box.style.padding = "10px";
      box.style.fontSize = "13px";
      box.style.lineHeight = "1.6";

      const hint = document.createElement("div");
      hint.textContent = "â€»é•·æŠ¼ã—â†’ã€Œã‚³ãƒ”ãƒ¼ã€ã§OK";
      hint.style.marginTop = "8px";
      hint.style.fontSize = "12px";
      hint.style.color = "rgba(0,0,0,.6)";

      card.appendChild(top);
      card.appendChild(box);
      card.appendChild(hint);

      overlay.appendChild(card);

      // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ãªã„ï¼ˆã‚ãªãŸã®æ–¹é‡ï¼‰
      // overlay.addEventListener("click", e=> { if(e.target===overlay) overlay.remove(); });

      document.body.appendChild(overlay);
    }

    box.value = text;

    // é–‹ã„ãŸç¬é–“ã«å…¨é¸æŠï¼ˆiOSã¯ã“ã‚Œã§é•·æŠ¼ã—ã—ã‚„ã™ã„ï¼‰
    setTimeout(()=>{
      box.focus();
      box.select();
      box.setSelectionRange(0, box.value.length);
    }, 50);
  }

  // =========================================================
  // 1) localStorageã‚­ãƒ¼ï¼ˆãƒ‡ãƒ¼ã‚¿/ãƒ†ãƒ¼ãƒ/ãƒã‚¤ãƒ†ãƒ¼ãƒï¼‰
  // =========================================================
  const DATA_KEY  = "furuyoni_match_logs_v1";
  const THEME_KEY = "furuyoni_theme_v1";
  const MY_THEMES_KEY = "furuyoni_theme_presets_v1";

  // =========================================================
  // 1.5) ãƒ¦ãƒ¼ã‚¶ãƒ¼è¾æ›¸ï¼ˆãƒ¡ã‚¬ãƒŸ/BAN çµ±ä¸€ï¼‰
  // =========================================================
  const DICT_KEY = "tsumilog_user_dict_v1";

  function loadDict(){
    try{
      const arr = JSON.parse(localStorage.getItem(DICT_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }
  function saveDict(list){
    localStorage.setItem(DICT_KEY, JSON.stringify(list));
  }
  function normText(s){
    return String(s||"").trim().replace(/\s+/g," ").normalize("NFKC");
  }
  function nextDictId(dict){
    const max = dict.reduce((m,x)=>Math.max(m, Number(x.id)||0), 0);
    return max + 1;
  }
  function upsertDict(text){
    const label = String(text||"").trim();
    const key = normText(label);
    if(!key) return null;

    const dict = loadDict();
    const hit = dict.find(x => x.key === key);
    if(hit) return hit;

    const item = { id: nextDictId(dict), key, label };
    dict.push(item);
    saveDict(dict);
    return item;
  }
  function renderWordDatalist(){
    const dl = document.getElementById("wordList");
    if(!dl) return;

    const dict = loadDict();
    dl.innerHTML = dict
      .slice()
      .sort((a,b)=>String(a.label).localeCompare(String(b.label),"ja"))
      .map(x => `<option value="${escapeHtml(x.label)}"></option>`)
      .join("");
  }

  // =========================================================
  // 2) ãƒ†ãƒ¼ãƒï¼šãƒ—ãƒªã‚»ãƒƒãƒˆ + è‡ªç”±ç·¨é›† + å…±æœ‰ï¼ˆJSONï¼‰ + ãƒã‚¤ãƒ†ãƒ¼ãƒ
  // =========================================================
  const DEFAULT_THEME = {
    bg1: "rgba(14,165,233,.13)",
    bg2: "rgba(34,197,94,.10)",
    bgTop: "#f7fbff",
    bgBottom: "#f7fff9",
    text: "#1f2937",
    muted: "#6b7280",
    card: "rgba(255,255,255,.80)",
    stroke: "rgba(31,41,55,.14)",
    accent: "#ff7a2f",
    accent2: "#ffd2a8",
  };

  const PRESETS = [
    { name: "ãƒŸãƒ³ãƒˆ", theme: { ...DEFAULT_THEME } },
    {
      name: "ã‚µãƒ³ã‚»ãƒƒãƒˆ",
      theme: {
        ...DEFAULT_THEME,
        bg1: "rgba(255,122,47,.14)",
        bg2: "rgba(255,210,168,.18)",
        bgTop: "#fff7f0",
        bgBottom: "#fffdf8",
        accent: "#ff7a2f",
        accent2: "#ffd2a8",
      }
    },
    {
      name: "ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼",
      theme: {
        ...DEFAULT_THEME,
        bg1: "rgba(168,85,247,.14)",
        bg2: "rgba(59,130,246,.10)",
        bgTop: "#fbf7ff",
        bgBottom: "#f7fbff",
        accent: "#7c3aed",
        accent2: "#c4b5fd",
      }
    },
    {
      name: "ãƒ¢ãƒã‚¯ãƒ­",
      theme: {
        ...DEFAULT_THEME,
        bg1: "rgba(0,0,0,.06)",
        bg2: "rgba(0,0,0,.04)",
        bgTop: "#f8fafc",
        bgBottom: "#f3f4f6",
        text: "#111827",
        muted: "#6b7280",
        accent: "#111827",
        accent2: "#9ca3af",
      }
    }
  ];

  function normalizeTheme(t){
    const out = {};
    for(const k of Object.keys(DEFAULT_THEME)){
      out[k] = (t && typeof t[k] === "string" && t[k] !== "") ? t[k] : DEFAULT_THEME[k];
    }
    return out;
  }
  function sameTheme(a,b){
    return JSON.stringify(normalizeTheme(a)) === JSON.stringify(normalizeTheme(b));
  }

  function loadTheme(){
    try{
      return { ...DEFAULT_THEME, ...(JSON.parse(localStorage.getItem(THEME_KEY) || "{}")) };
    }catch{
      return { ...DEFAULT_THEME };
    }
  }
  function saveTheme(theme){
    localStorage.setItem(THEME_KEY, JSON.stringify(theme));
  }
  function applyTheme(theme){
    const r = document.documentElement.style;
    r.setProperty("--bg1", theme.bg1);
    r.setProperty("--bg2", theme.bg2);
    r.setProperty("--bgTop", theme.bgTop);
    r.setProperty("--bgBottom", theme.bgBottom);
    r.setProperty("--text", theme.text);
    r.setProperty("--muted", theme.muted);
    r.setProperty("--card", theme.card);
    r.setProperty("--stroke", theme.stroke);
    r.setProperty("--accent", theme.accent);
    r.setProperty("--accent2", theme.accent2);
  }

  // èµ·å‹•æ™‚ã«ãƒ†ãƒ¼ãƒé©ç”¨ï¼ˆä¿å­˜æ¸ˆã¿ãŒã‚ã‚Œã°ãã‚Œï¼‰
  applyTheme(loadTheme());

  // --- ãƒã‚¤ãƒ†ãƒ¼ãƒä¿å­˜ ---
  function loadMyThemes(){
    try{
      const arr = JSON.parse(localStorage.getItem(MY_THEMES_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }
  function saveMyThemes(list){
    localStorage.setItem(MY_THEMES_KEY, JSON.stringify(list));
  }

  function hexOrFallback(colorStr, fallback){
    return (typeof colorStr === "string" && colorStr.startsWith("#")) ? colorStr : fallback;
  }

  function fillThemeInputs(theme){
    $("t_accent").value   = hexOrFallback(theme.accent, DEFAULT_THEME.accent);
    $("t_accent2").value  = hexOrFallback(theme.accent2, DEFAULT_THEME.accent2);
    $("t_text").value     = hexOrFallback(theme.text, DEFAULT_THEME.text);
    $("t_muted").value    = hexOrFallback(theme.muted, DEFAULT_THEME.muted);
    $("t_bgTop").value    = hexOrFallback(theme.bgTop, DEFAULT_THEME.bgTop);
    $("t_bgBottom").value = hexOrFallback(theme.bgBottom, DEFAULT_THEME.bgBottom);

    $("t_bg1").value    = theme.bg1 || DEFAULT_THEME.bg1;
    $("t_bg2").value    = theme.bg2 || DEFAULT_THEME.bg2;
    $("t_card").value   = theme.card || DEFAULT_THEME.card;
    $("t_stroke").value = theme.stroke || DEFAULT_THEME.stroke;
  }

  function buildThemeFromInputs(){
    const current = loadTheme();
    return {
      ...current,
      accent:   $("t_accent").value,
      accent2:  $("t_accent2").value,
      text:     $("t_text").value,
      muted:    $("t_muted").value,
      bgTop:    $("t_bgTop").value,
      bgBottom: $("t_bgBottom").value,
      bg1:   ($("t_bg1").value || current.bg1),
      bg2:   ($("t_bg2").value || current.bg2),
      card:  ($("t_card").value || current.card),
      stroke:($("t_stroke").value || current.stroke),
    };
  }

  // âœ… ãƒ—ãƒªã‚»ãƒƒãƒˆæç”»ï¼ˆbuiltin + myThemesï¼‰ï¼† active/ç¾åœ¨è¡¨ç¤ºã‚‚ã“ã“ã§å®Œçµ
  function renderPresetButtons(){
    const bar = $("presetBar");
    const myThemes = loadMyThemes();

    const all = [
      ...PRESETS.map(p => ({ type:"builtin", name:p.name, theme:p.theme })),
      ...myThemes.map(p => ({ type:"custom", name:p.name, theme:p.theme })),
    ];

    const cur = loadTheme();

    bar.innerHTML = all.map((p, i) => {
      const isActive = sameTheme(p.theme, cur);
      const delBtn = (p.type==="custom")
        ? `<button type="button" class="presetBtn" data-del="${p.name}"
            style="border-color:rgba(216,58,58,.35);color:var(--danger);">å‰Šé™¤</button>`
        : "";

      return `
        <div style="display:flex;gap:6px;align-items:center;">
          <button type="button" class="presetBtn ${isActive ? "active" : ""}" data-preset-index="${i}">
            ${p.type==="custom" ? "â˜… " : ""}${p.name}
          </button>
          ${delBtn}
        </div>
      `;
    }).join("");

    // ç¾åœ¨ãƒ©ãƒ™ãƒ«
    const label = $("themeCurrentLabel");
    if(label){
      const hit = all.find(p => sameTheme(p.theme, cur));
      label.textContent = hit ? `ç¾åœ¨ï¼š${hit.name}` : "ç¾åœ¨ï¼šã‚«ã‚¹ã‚¿ãƒ ";
    }

    // é©ç”¨
    bar.querySelectorAll("[data-preset-index]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.getAttribute("data-preset-index"));
        const preset = all[idx];
        if(!preset) return;

        saveTheme(preset.theme);
        applyTheme(preset.theme);
        fillThemeInputs(preset.theme);

        // active/ç¾åœ¨è¡¨ç¤ºã‚’æ›´æ–°
        renderPresetButtons();
      });
    });

    // å‰Šé™¤ï¼ˆcustomã®ã¿ï¼‰
    bar.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const name = btn.getAttribute("data-del");
        if(!name) return;

        const ok = confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nå–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`);
        if(!ok) return;

        const list = loadMyThemes().filter(x => x.name !== name);
        saveMyThemes(list);
        renderPresetButtons();
      });
    });
  }

  // ãƒã‚¤ãƒ†ãƒ¼ãƒä¿å­˜ãƒœã‚¿ãƒ³
  $("saveMyThemeBtn").addEventListener("click", ()=>{
    const name = ($("myThemeName").value || "").trim();
    if(!name){
      alert("ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ã­");
      return;
    }

    const theme = buildThemeFromInputs();
    const list = loadMyThemes();
    const exists = list.find(x => x.name === name);

    if(exists){
      const ok = confirm(`ã€Œ${name}ã€ã¯æ—¢ã«ã‚ã‚Šã¾ã™ã€‚\nä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`);
      if(!ok) return;
      exists.theme = theme;
    }else{
      list.unshift({ name, theme }); // ã‚ˆãä½¿ã†ã®ãŒä¸Šã«æ¥ã‚‹
    }

    saveMyThemes(list);

    // ã„ã¾ã®ãƒ†ãƒ¼ãƒã¨ã—ã¦ã‚‚ä¿å­˜ï¼†é©ç”¨
    saveTheme(theme);
    applyTheme(theme);
    fillThemeInputs(theme);

    renderPresetButtons();
    alert(`ã€Œ${name}ã€ã¨ã—ã¦ä¿å­˜ã—ãŸã‚ˆï¼`);
  });

  function openThemeModal(){
    renderPresetButtons();
    fillThemeInputs(loadTheme());
    $("themeModal").style.display = "flex";
    $("themeModal").setAttribute("aria-hidden", "false");
  }
  function closeThemeModal(){
    $("themeModal").style.display = "none";
    $("themeModal").setAttribute("aria-hidden", "true");
  }
  $("openTheme").addEventListener("click", openThemeModal);
  $("closeTheme").addEventListener("click", closeThemeModal);

  // æ‰‹å‹•èª¿æ•´ â†’ é©ç”¨
  $("applyThemeBtn").addEventListener("click", ()=>{
    const theme = buildThemeFromInputs();
    saveTheme(theme);
    track("theme_apply", { source: "manual" });
    applyTheme(theme);
    renderPresetButtons();
    track("theme_apply", { source: "manual" });
    closeThemeModal();
  });

  // åˆæœŸã«æˆ»ã™
  $("resetThemeBtn").addEventListener("click", ()=>{
    saveTheme(DEFAULT_THEME);
    applyTheme(DEFAULT_THEME);
    fillThemeInputs(DEFAULT_THEME);
    renderPresetButtons();
    closeThemeModal();
  });

  // --- å…±æœ‰ï¼ˆJSONï¼‰ ---
  function safeParseThemeJson(text){
    let obj;
    try{ obj = JSON.parse(text); }
    catch{ return { ok:false, err:"JSONã¨ã—ã¦èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ" }; }

    if(!obj || typeof obj !== "object"){
      return { ok:false, err:"å½¢å¼ãŒä¸æ­£ã§ã™ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰" };
    }

    const theme = normalizeTheme(obj);
    for(const k of Object.keys(DEFAULT_THEME)){
      if(typeof theme[k] !== "string" || theme[k].trim() === ""){
        return { ok:false, err:`"${k}" ãŒä¸æ­£ã§ã™` };
      }
    }
    return { ok:true, theme };
  }

  $("exportThemeBtn").addEventListener("click", async ()=>{
    const theme = normalizeTheme(loadTheme());
    const json = JSON.stringify(theme, null, 2);
    $("themeJsonBox").value = json;

    try{
      await navigator.clipboard.writeText(json);
      alert("ãƒ†ãƒ¼ãƒJSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");

      track("theme_export", {
        method: "clipboard"
      });

    }catch{
      alert("ã‚³ãƒ”ãƒ¼ã§ããªã‹ã£ãŸã®ã§ã€ä¸‹ã®æ¬„ã‹ã‚‰æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");

      track("theme_export", {
        method: "manual"
      });
    }
  });

  $("importThemeBtn").addEventListener("click", ()=>{
    const text = ($("themeJsonBox").value || "").trim();
    if(!text){
      alert("è²¼ã‚Šä»˜ã‘æ¬„ãŒç©ºã§ã™ã€‚ãƒ†ãƒ¼ãƒJSONã‚’è²¼ã£ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const r = safeParseThemeJson(text);
    if(!r.ok){
      alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼š${r.err}`);

      track("theme_import", { ok: false, reason: "parse_error" });
      return;
    }

    saveTheme(r.theme);
    applyTheme(r.theme);
    fillThemeInputs(r.theme);
    renderPresetButtons();
    alert("ãƒ†ãƒ¼ãƒã‚’é©ç”¨ã—ã¾ã—ãŸï¼");

    track("theme_import", { ok: true });
  });

  // =========================================================
  // 3) ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé–‹é–‰ï¼‰
  // =========================================================
  function openHelp(){
    $("helpModal").style.display = "flex";
    $("helpModal").setAttribute("aria-hidden", "false");
  }
  function closeHelp(){
    $("helpModal").style.display = "none";
    $("helpModal").setAttribute("aria-hidden", "true");
  }
  $("openHelp").addEventListener("click", openHelp);
  $("closeHelp").addEventListener("click", closeHelp);

  // =========================================================
  // 4) æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // =========================================================
  const pad2 = (n) => String(n).padStart(2, "0");

  function nowStr(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  }
  function todayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
  function yearFromTs(ts){
    const y = String(ts||"").slice(0,4);
    return /^\d{4}$/.test(y) ? y : null;
  }

  // =========================================================
  // 5) ãƒ‡ãƒ¼ã‚¿èª­ã¿æ›¸ãï¼ˆè©¦åˆãƒ­ã‚°ï¼‰
  // =========================================================
  function loadRows(){
    try{ return JSON.parse(localStorage.getItem(DATA_KEY) || "[]"); }
    catch{ return []; }
  }
  function saveRows(rows){
    localStorage.setItem(DATA_KEY, JSON.stringify(rows));
  }

  // =========================================================
  // 6) è¡¨ç¤ºç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // =========================================================
  const MATCH_TYPE_LABEL = {
    tournament: "å¤§ä¼š",
    free: "ãƒ•ãƒªãƒ—",
    rank: "ãƒ©ãƒ³ã‚¯",
  };
  function matchTypeText(v){
    return MATCH_TYPE_LABEL[v] || "â€”";
  }
  
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function pairName(a,b){
    const x=(a||"").trim(), y=(b||"").trim();
    if(x && y) return `${x}/${y}`;
    return x || y || "?";
  }

  // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ state
  let currentDetailId = null;

  function openDetailById(id){
    const rows = loadRows();
    const r = rows.find(x => x.id === id);
    if(!r) return;

    currentDetailId = id;

    const badges = [];
    badges.push(`<span class="chip">ğŸ•’ ${escapeHtml(r.ts || "")}</span>`);

    const resText = r.result === "WIN" ? "å‹ã¡" : "è² ã‘";
    badges.push(`<span class="chip">${r.result === "WIN" ? "â—" : "Ã—"}   ${escapeHtml(resText)}</span>`);

    const mt = matchTypeText(r.matchType);
    if(mt !== "â€”") badges.push(`<span class="chip">ğŸ“Œ ${escapeHtml(mt)}</span>`);
    if(r.turn) badges.push(`<span class="chip">${escapeHtml(r.turn)}</span>`);
    if(r.tag)  badges.push(`<span class="chip">#${escapeHtml(r.tag)}</span>`);

    $("detailMeta").innerHTML = badges.join(" ");

    const myTeam = pairName(r.my1,r.my2);
    const theirTeam = pairName(r.their1,r.their2);

    const baseLines = [];
    baseLines.push(`ä½¿ç”¨ï¼š${myTeam} vs ${theirTeam}`);
    baseLines.push(`å‹æ•—ï¼š${resText}`);
    baseLines.push(`åŒºåˆ†ï¼š${mt}`);
    baseLines.push(`å…ˆå¾Œï¼š${r.turn || "â€”"}`);
    if(r.opponent) baseLines.push(`ç›¸æ‰‹ï¼š${r.opponent}`);
    $("detailBase").textContent = baseLines.join("\n");

    $("detailBan").textContent = `è‡ªåˆ†ï¼š${r.myBan || "â€”"} / ç›¸æ‰‹ï¼š${r.theirBan || "â€”"}`;
    $("detailPivot").textContent = r.pivot || "â€”";
    $("detailNext").textContent = r.next || "â€”";

    $("detailModal").style.display = "flex";
    $("detailModal").setAttribute("aria-hidden", "false");
  }

  function closeDetail(){
    $("detailModal").style.display = "none";
    $("detailModal").setAttribute("aria-hidden", "true");
    currentDetailId = null;
  }

  $("closeDetail").addEventListener("click", closeDetail);
  // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ãªã„é‹ç”¨ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã®ã¾ã¾ã§OK
  // $("detailModal").addEventListener("click", (e)=>{ if(e.target === $("detailModal")) closeDetail(); });

  // =========================================================
  // 7) å‹ç‡è¨ˆç®—
  // =========================================================
  function summarizeWinRate(rows){
    const w = rows.filter(r=>r.result==="WIN").length;
    const l = rows.filter(r=>r.result==="LOSE").length;
    const total = w+l;
    const rate = total>0 ? Math.round((w/total)*100) : null;
    return {w,l,total,rate};
  }
  function getTodayRows(rows){
    const t=todayKey();
    return rows.filter(r => (r.ts||"").startsWith(t));
  }
  function getYearRows(rows, yearStr){
    const p = `${yearStr}-`;
    return rows.filter(r => (r.ts||"").startsWith(p));
  }

  function filterByType(rows, type){
    if(!type || type === "ALL") return rows;
    return rows.filter(r => (r.matchType || "") === type);
  }

  // =========================================================
  // 8) å¹´ã‚»ãƒ¬ã‚¯ãƒˆ
  // =========================================================
  const TYPE_SEL_KEY = "furuyoni_type_sel_v1";

  const state = {
    selectedYear: String(new Date().getFullYear()),
    selectedType: (localStorage.getItem(TYPE_SEL_KEY) || "ALL"),
  };

  function buildYearOptions(rows){
    const years = new Set();
    for(const r of rows){
      const y = yearFromTs(r.ts);
      if(y) years.add(y);
    }
    years.add(String(new Date().getFullYear()));
    return [...years].sort((a,b)=>Number(b)-Number(a));
  }
  function renderYearSelect(rows){
    const years = buildYearOptions(rows);
    const sel = $("yearSelect");
    sel.innerHTML = years.map(y=>`<option value="${y}">${y}å¹´</option>`).join("");
    if(!years.includes(state.selectedYear)) state.selectedYear = years[0] || String(new Date().getFullYear());
    sel.value = state.selectedYear;
  }

  // =========================================================
  // 9) ç”»é¢æç”»
  // =========================================================
  function renderHeader(rows){
    $("countChip").textContent = `${rows.length}ä»¶`;

    const s = summarizeWinRate(getTodayRows(rows));
    let text = `ä»Šæ—¥ï¼š${s.w}å‹${s.l}æ•—`;
    if(s.rate !== null) text += `ï¼ˆ${s.rate}%ï¼‰`;
    $("todayRateChip").textContent = text;
    $("todayChip").textContent = `ä»Šæ—¥ï¼š${s.w}å‹${s.l}æ•—`;
  }

  function renderStats(rows){
    const base = filterByType(rows, state.selectedType);

    if(base.length===0){
      $("statsMeta").textContent="è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“";
      $("rateToday").textContent="â€”";
      $("rateYear").textContent="â€”";
      $("rateAll").textContent="â€”";
      $("rateTodayMeta").textContent="";
      $("rateYearMeta").textContent="";
      $("rateAllMeta").textContent="";
      return;
    }

    const sToday = summarizeWinRate(getTodayRows(base));
    const sYear  = summarizeWinRate(getYearRows(base, state.selectedYear));
    const sAll   = summarizeWinRate(base);

    $("statsMeta").textContent = `æ›´æ–°ï¼š${nowStr()}`;

    $("rateToday").textContent = sToday.rate===null ? "â€”" : `${sToday.rate}%`;
    $("rateYear").textContent  = sYear.rate===null  ? "â€”" : `${sYear.rate}%`;
    $("rateAll").textContent   = sAll.rate===null   ? "â€”" : `${sAll.rate}%`;

    $("rateTodayMeta").textContent = `${sToday.w}å‹ / ${sToday.total}æˆ¦`;
    $("rateYearMeta").textContent  = `${sYear.w}å‹ / ${sYear.total}æˆ¦ï¼ˆ${state.selectedYear}å¹´ 1æœˆã€œ12æœˆï¼‰`;
    $("rateAllMeta").textContent   = `${sAll.w}å‹ / ${sAll.total}æˆ¦`;
  }

  function renderRecent(rows){
    const area = $("recentArea");
    if(rows.length===0){
      area.innerHTML = `<div class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    const sorted = rows.slice().sort((a,b)=>b.id-a.id).slice(0,6);

    let html = `<table><tbody>`;
    for(const r of sorted){
      const res = r.result==="WIN" ? "å‹ã¡" : "è² ã‘";
      const mark = r.result==="WIN" ? "â—" : "Ã—";
      const myTeam = pairName(r.my1,r.my2);
      const theirTeam = pairName(r.their1,r.their2);
      const mt = matchTypeText(r.matchType);

      html += `
        <tr>
          <td style="width:92px">
            <span class="mini">${escapeHtml((r.ts||"").slice(11))}</span><br>
            <b>${mark} ${res}</b>
          </td>
          <td>
            <span class="linklike" data-id="${r.id}">${escapeHtml(myTeam)} vs ${escapeHtml(theirTeam)}</span>
            <span class="mini">ã€€[${escapeHtml(mt)}]</span>
            ${r.tag ? `<span class="mini">ã€€#${escapeHtml(r.tag)}</span>` : ""}
            <div class="mini">åçœï¼š${escapeHtml(r.pivot||"")}</div>
          </td>
          <td style="width:110px" class="mini">${escapeHtml(r.opponent||"")}</td>
        </tr>
      `;
    }
    html += `</tbody></table>`;
    area.innerHTML = html;

    area.querySelectorAll("[data-id]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const id = Number(el.getAttribute("data-id"));
        openDetailById(id);

        track("log_open_detail", {
          source: "recent",
          result: r.result,
          match_type: r.matchType || "none"
        });
      });
    });
  }

  function refresh(){
    renderWordDatalist();
    const rows = loadRows();
    renderYearSelect(rows);
    const typeSel = $("typeSelect");
    if(typeSel){
      typeSel.value = state.selectedType;
    }

    renderHeader(rows);
    renderStats(rows);
    renderRecent(rows);
    $("nowChip").textContent = nowStr();

    const vb = $("versionBadge");
    if(vb) vb.textContent = `v${APP_VERSION}`;
  }

  // =========================================================
  // 10) ãƒ•ã‚©ãƒ¼ãƒ æ“ä½œ
  // =========================================================
  function autoGrow(el){
    el.style.height = "auto";
    el.style.height = (el.scrollHeight) + "px";
  }
  ["pivot","next"].forEach(id=>{
    const el = $(id);
    el.addEventListener("input", ()=>autoGrow(el));
    autoGrow(el);
  });

  function clearFormAll(){
    $("opponent").value="";
    $("result").value="WIN";
    $("my1").value="";
    $("my2").value="";
    $("their1").value="";
    $("their2").value="";
    $("myBan").value="";
    $("theirBan").value="";
    $("turn").value="";
    $("matchType").value="";
    $("tag").value="";
    $("pivot").value="";
    $("next").value="";
    $("opponent").focus();
    autoGrow($("pivot"));
    autoGrow($("next"));
  }

  // =========================================================
  // 11) ã‚¤ãƒ™ãƒ³ãƒˆ
  // =========================================================
  $("f").addEventListener("submit", (e)=>{
    e.preventDefault();

    // å…ˆã«å…¥åŠ›æ–‡å­—åˆ—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
    const my1 = $("my1").value.trim();
    const my2 = $("my2").value.trim();
    const their1 = $("their1").value.trim();
    const their2 = $("their2").value.trim();
    const myBan = $("myBan").value.trim();
    const theirBan = $("theirBan").value.trim();

    // è¾æ›¸ã«çµ±ä¸€ç™»éŒ²ï¼ˆåŒã˜æ–‡å­—åˆ—ãªã‚‰åŒã˜IDï¼‰
    const my1Item = upsertDict(my1);
    const my2Item = upsertDict(my2);
    const their1Item = upsertDict(their1);
    const their2Item = upsertDict(their2);
    const myBanItem = upsertDict(myBan);
    const theirBanItem = upsertDict(theirBan);

    const entry = {
      id: Date.now(),
      ts: nowStr(),
      opponent: $("opponent").value.trim(),
      result: $("result").value,

      // è¡¨ç¤ºã¯ä»Šã¾ã§é€šã‚Šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›æ–‡å­—åˆ—ï¼‰
      my1, my2, their1, their2,
      myBan, theirBan,

      // è¾æ›¸IDï¼ˆå°†æ¥ã®æ±ç”¨åŒ–ãƒ»å·®åˆ†åˆ¤å®šç”¨ï¼‰
      my1Id: my1Item?.id ?? null,
      my2Id: my2Item?.id ?? null,
      their1Id: their1Item?.id ?? null,
      their2Id: their2Item?.id ?? null,
      myBanId: myBanItem?.id ?? null,
      theirBanId: theirBanItem?.id ?? null,

      turn: $("turn").value,
      matchType: $("matchType").value,
      tag: $("tag").value.trim(),
      pivot: $("pivot").value.trim(),
      next: $("next").value.trim(),
    };

    if(!entry.my1 || !entry.my2 || !entry.their1 || !entry.their2){
      alert("å¿…é ˆé …ç›®ã‚’åŸ‹ã‚ã¦ã­ï¼ˆè‡ªåˆ†2 / ç›¸æ‰‹2ï¼‰");
      return;
    }

    const rows = loadRows();
    rows.push(entry);
    saveRows(rows);

    track("log_save", {
      result: entry.result,                 // WIN / LOSE
      match_type: entry.matchType || "none",
      has_opponent: !!entry.opponent,
      has_tag: !!entry.tag,
      has_pivot: !!entry.pivot,
      has_next: !!entry.next
    });

    // è¾æ›¸å€™è£œã‚‚æ›´æ–°
    renderWordDatalist();

    clearFormAll();
    refresh();
  });

  $("clearForm").addEventListener("click", clearFormAll);

  $("wipeAll").addEventListener("click", ()=>{
    const rows = loadRows();
    if(rows.length===0){
      alert("å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }
    const ok = confirm(
      `å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆ${rows.length}ä»¶ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n` +
      `ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\n` +
      `æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`
    );
    if(!ok) return;
    localStorage.removeItem(DATA_KEY);
    refresh();
  });

  $("yearSelect").addEventListener("change", ()=>{
    state.selectedYear = $("yearSelect").value;
    renderStats(loadRows());
  });
  
  $("typeSelect").addEventListener("change", ()=>{
    state.selectedType = $("typeSelect").value;
    localStorage.setItem(TYPE_SEL_KEY, state.selectedType);

    // âœ… åŒºåˆ†ãŒå¤‰ã‚ã£ãŸã‚‰å‹ç‡ã®è¡¨ç¤ºã‚’æ›´æ–°
    const rows = loadRows();
    renderHeader(rows); // ä»Šæ—¥ãƒãƒƒãƒ—ç­‰ã‚‚æ›´æ–°ã—ãŸã„ãªã‚‰
    renderStats(rows);
  });

  // åˆæœŸåŒ–
  refresh();
  setInterval(()=>{ $("nowChip").textContent = nowStr(); }, 10*1000);
})();
</script>
</body>
</html>