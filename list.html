<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã¤ã¿ãƒ­ã‚°ï¼ˆä¸€è¦§ï¼‰</title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YY44S858BX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}

  // åˆæœŸåŒ–
  gtag('js', new Date());

  // è¨­å®šï¼ˆå¿…è¦ãªã‚‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ ï¼‰
  gtag('config', 'G-YY44S858BX', {
    // ä¾‹ï¼šé–‹ç™ºä¸­ã ã‘ãƒ‡ãƒãƒƒã‚°ã—ãŸã„å ´åˆ
    // debug_mode: true
  });
</script>

<style>
  :root{
    --bg1: rgba(14,165,233,.13);
    --bg2: rgba(34,197,94,.10);
    --bgTop: #f7fbff;
    --bgBottom: #f7fff9;

    --text:#1f2937;
    --muted:#6b7280;

    --card: rgba(255,255,255,.80);
    --stroke: rgba(31,41,55,.14);

    --accent:#ff7a2f;
    --accent2:#ffd2a8;

    --danger:#d83a3a;
    --ok:#1d8f5a;

    --shadow:0 14px 38px rgba(0,0,0,.08);
    --r:18px;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI","Hiragino Sans","Noto Sans JP",sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 600px at 18% 6%, var(--bg1), transparent 60%),
      radial-gradient(900px 700px at 85% 15%, var(--bg2), transparent 60%),
      linear-gradient(180deg, var(--bgTop), var(--bgBottom));
    min-height:100vh;
  }

  header{
    padding:18px 16px 10px;
    max-width:1100px;
    margin:0 auto;
    display:flex;
    gap:12px;
    align-items:flex-end;
    justify-content:space-between;
  }
  .title{font-weight:900;font-size:20px}
  .rightHead{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .chip{
    font-size:12px;padding:4px 10px;border-radius:999px;
    border:1px solid rgba(0,0,0,.08);background:#fff;color:var(--muted);white-space:nowrap
  }
  .chipBtn{font:inherit;cursor:pointer}

  .wrap{max-width:1100px;margin:0 auto;padding:0 16px 22px}
  .card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--r);
    box-shadow:var(--shadow);
    backdrop-filter: blur(8px);
  }
  .card h2{
    font-size:14px;margin:0;padding:14px 14px 10px;
    border-bottom:1px solid rgba(0,0,0,.06);
    display:flex;align-items:center;justify-content:space-between;gap:10px
  }

  .tools{
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    margin:10px 14px 10px;
  }
  input, select, textarea{
    padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;
    font:inherit;
  }
  textarea{resize:vertical;min-height:120px;line-height:1.6}
  .tools input{min-width:260px;max-width:420px;flex:1}

  button{border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
  .ghost{background:#fff;border:1px solid rgba(0,0,0,.12);color:var(--text)}
  .primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
  .dangerBtn{background:#fff;border:1px solid rgba(216,58,58,.35);color:var(--danger)}
  .miniBtn{padding:7px 10px;border-radius:999px;font-weight:900}

  .pager{
    display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    margin: 8px 14px 6px;
  }
  .pager .mini{margin-left:auto;color:var(--muted);font-size:12px}
  .pager button{
    padding:8px 10px;border-radius:999px;background:#fff;border:1px solid rgba(0,0,0,.12);font-weight:900
  }
  .pager button[disabled]{opacity:.45;cursor:not-allowed}

  table{width:calc(100% - 28px);margin:0 14px 14px;border-collapse:separate;border-spacing:0 8px}
  td{
    background:#fff;border:1px solid rgba(0,0,0,.08);
    padding:10px;font-size:13px;vertical-align:top
  }
  td:first-child{border-radius:12px 0 0 12px}
  td:last-child{border-radius:0 12px 12px 0}

  .mini{color:var(--muted);font-size:12px}
  .linklike{color:var(--accent);text-decoration:underline;cursor:pointer;font-weight:900}
  .empty{color:var(--muted);padding:12px 14px 14px;font-size:13px}

  /* =========================
    ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šï¼ˆãƒ˜ãƒ«ãƒ—/è©³ç´°ï¼‰
  ========================= */
  .modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.35);
    padding:16px;
    z-index:999;
    align-items:center;
    justify-content:center;
  }
  .modal .inner{
    max-width:760px;
    margin:40px auto;
    padding:14px;
    max-height: calc(100vh - 32px);
    overflow:auto;
  }
  .modalTop{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .modalTitle{
    margin:0;
    font-size:16px;
    font-weight:900;
  }
  .helpBox, .detailBox{
    background:#fff;
    border:1px solid rgba(0,0,0,.08);
    border-radius:14px;
    padding:12px;
    line-height:1.7;
    font-size:14px;
  }

/* =========================
   è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«å°‚ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
   ï¼ˆãƒ˜ãƒ«ãƒ—ã«ã¯å½±éŸ¿ã•ã›ãªã„ï¼‰
========================= */

  /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ä¸Šå¯„ã›å›ºå®š */
  #detailModal{
    align-items: flex-start;   /* ä¸Šå›ºå®š */
    justify-content: center;
  }

  /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚«ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºå›ºå®š */
  #detailModal .inner{
    width: min(760px, calc(100vw - 32px));
    height: min(78vh, calc(100vh - 32px));
    margin: 24px 0 0;           /* é ­ã®ä½ç½®å›ºå®š */

    display: flex;
    flex-direction: column;

    overflow: hidden;           /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ä¸­ã ã‘ */
  }

  /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã ã‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
  #detailModal .detailBox{
    flex: 1;
    overflow: auto;
    min-height: 0;              /* flexå†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®‰å®š */
}

  /* è©³ç´°ï¼šä¸Šéƒ¨ãƒãƒƒã‚¸ */
  .detailMeta{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    background:#fff;
    border:1px solid rgba(0,0,0,.10);
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
  }
  .tagBadge{
    color: var(--text);
    border-color: rgba(255,122,47,.35);
  }
  .winBadge{
    color: var(--ok);
    border-color: rgba(29,143,90,.25);
  }
  .loseBadge{
    color: var(--danger);
    border-color: rgba(216,58,58,.25);
  }

  .detailGrid{display:grid;gap:10px}
  .cap{font-size:12px;color:var(--muted);margin-bottom:6px}
  .pre{white-space:pre-wrap;word-break:break-word}

  /* è©³ç´°ï¼šç·¨é›†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
  .editGrid{display:grid;gap:10px;margin-top:10px}
  .editGrid .row{display:flex;flex-direction:column;gap:6px}
  .twoCol{
    display:grid;
    gap:10px;
    grid-template-columns:1fr 1fr;
  }
  @media (max-width: 720px){
    .twoCol{grid-template-columns:1fr}
  }

  /* å‰ã¸/æ¬¡ã¸ãƒœã‚¿ãƒ³ */
  .navBtns{display:flex;gap:8px;flex-wrap:wrap}
  .navBtns button{border-radius:999px;padding:8px 10px}
  .navBtns button[disabled]{opacity:.45;cursor:not-allowed}

  /* ä¸€è¦§ï¼šæ“ä½œåˆ— */
  .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}

  /* â–¼ ãƒãƒ¼ã‚¸ãƒ§ãƒ³å³ä¸‹è¡¨ç¤º */
  .versionBadge{
    position: fixed;
    right: 16px;
    bottom: 16px;
    font-size: 12px;
    opacity: 0.6;
    background: rgba(0,0,0,0.05);
    padding: 6px 10px;
    border-radius: 12px;
    backdrop-filter: blur(4px);
    z-index: 999;
    transition: opacity 0.2s ease;
  }

  .versionBadge:hover{
    opacity: 1;
  }
</style>
</head>

<body>
<header>
  <div class="title">ğŸŒ± ã¤ã¿ãƒ­ã‚°</div>
  <div class="rightHead">
    <a class="chip" href="index.html" style="text-decoration:none;color:inherit;">â† å…¥åŠ›ã¸</a>
    <button class="chip chipBtn" id="openHelp" type="button">â“ ãƒ˜ãƒ«ãƒ—</button>
    <button class="chip chipBtn" id="openData" type="button">ğŸ“¦ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <div class="chip" title="ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚">ğŸ”’ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</div>
    <div class="chip" id="countChip">0ä»¶</div>
  </div>
</header>

<div class="wrap">
  <section class="card">
    <h2>
      <span>ä¸€è¦§ï¼ˆ30ä»¶ã”ã¨ï¼‰</span>
      <span class="chip" id="todayChip">ä»Šæ—¥ï¼š0å‹0æ•—</span>
    </h2>

    <div class="tools">
      <input id="q" placeholder="æ¤œç´¢ï¼ˆãƒ¡ã‚¬ãƒŸ/ç›¸æ‰‹/ã‚¿ã‚°/åçœç‚¹/BANï¼‰" />
      <select id="filter">
        <option value="ALL">å…¨ã¦</option>
        <option value="WIN">å‹ã¡ã®ã¿</option>
        <option value="LOSE">è² ã‘ã®ã¿</option>
        <option value="TODAY">ä»Šæ—¥ã®ã¿</option>
      </select>
      <select id="typeFilter" aria-label="åŒºåˆ†ãƒ•ã‚£ãƒ«ã‚¿">
        <option value="ALL">åŒºåˆ†ï¼šãªã—ï¼ˆå…¨éƒ¨ï¼‰</option>
        <option value="tournament">åŒºåˆ†ï¼šå¤§ä¼š</option>
        <option value="free">åŒºåˆ†ï¼šãƒ•ãƒªãƒ—</option>
        <option value="rank">åŒºåˆ†ï¼šãƒ©ãƒ³ã‚¯</option>
      </select>
    </div>

    <div class="pager" id="pager"></div>
    <div id="listArea"></div>
  </section>
</div>

<!-- ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="helpModal" class="modal" aria-hidden="true">
  <div class="card inner">
    <div class="modalTop">
      <h3 class="modalTitle">â“ ä½¿ã„æ–¹</h3>
      <button class="ghost" type="button" id="closeHelp">é–‰ã˜ã‚‹</button>
    </div>

    <div class="helpBox">
      <ul style="margin:0 0 0 18px;">
        <li>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ»30ä»¶ã”ã¨ã®ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãŒã§ãã¾ã™ã€‚</li>
        <li>åçœç‚¹ã¯ä¸€è¦§ã§ã¯<b>1è¡Œç›®ã ã‘</b>è¡¨ç¤ºã—ã¾ã™ï¼ˆè¦‹ã‚„ã™ã•å„ªå…ˆï¼‰ã€‚</li>
        <li>è¡Œã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆãƒ¡ã‚¬ãƒŸï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨<b>è©³ç´°</b>ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
        <li>ä¸€è¦§ã®ã€Œç·¨é›†ã€ã‹ã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã‘ã¾ã™ã€‚</li>
        <li>ç·¨é›†é€”ä¸­ã«ã€Œå‰ã¸/æ¬¡ã¸ã€ã€Œé–‰ã˜ã‚‹ã€ã‚’æŠ¼ã™ã¨ã€æœªä¿å­˜å¤‰æ›´ãŒã‚ã‚Œã°ç¢ºèªãŒå‡ºã¾ã™ã€‚</li>
        <li>âš ï¸ ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å¤‰ãˆã‚‹ã¨å¼•ãç¶™ã’ã¾ã›ã‚“ã€‚</li>
      </ul>
    </div>
  </div>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="detailModal" class="modal" aria-hidden="true">
  <div class="card inner">
    <div class="modalTop">
      <h3 class="modalTitle">ï¼œè©¦åˆã®è©³ç´°ï¼</h3>

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <div class="navBtns">
          <button class="ghost" type="button" id="prevBtn">â† å‰ã¸</button>
          <button class="ghost" type="button" id="nextBtn">æ¬¡ã¸ â†’</button>
        </div>
        <button class="ghost" type="button" id="detailEditBtn">ç·¨é›†</button>
        <button class="dangerBtn" type="button" id="detailDeleteBtn">å‰Šé™¤</button>
        <button class="ghost" type="button" id="closeDetail">é–‰ã˜ã‚‹</button>
      </div>
    </div>

    <div class="detailBox">
      <div class="detailMeta" id="detailMeta"></div>

      <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
      <div id="detailView">
        <div class="detailGrid">
          <div>
            <div class="cap">åŸºæœ¬æƒ…å ±</div>
            <div class="pre" id="detailBase">â€”</div>
          </div>

          <div>
            <div class="cap">BAN</div>
            <div class="pre" id="detailBan">â€”</div>
          </div>

          <div>
            <div class="cap">åçœç‚¹</div>
            <div class="pre" id="detailPivot">â€”</div>
          </div>

          <div>
            <div class="cap">æ”¹å–„ç‚¹</div>
            <div class="pre" id="detailNext">â€”</div>
          </div>
        </div>
      </div>

      <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
      <div id="detailEdit" style="display:none;">
        <div class="editGrid">
          <div class="twoCol">
            <div class="row">
              <div class="cap">å¯¾æˆ¦åŒºåˆ†</div>
              <select id="editMatchType">
                <option value="">â€”</option>
                <option value="tournament">å¤§ä¼š</option>
                <option value="free">ãƒ•ãƒªãƒ—</option>
                <option value="rank">ãƒ©ãƒ³ã‚¯</option>
              </select>
            </div>
            <div class="row">
              <div class="cap">å‹æ•—</div>
              <select id="editResult">
                <option value="WIN">å‹ã¡</option>
                <option value="LOSE">è² ã‘</option>
              </select>
            </div>

            <div class="row">
              <div class="cap">å…ˆå¾Œ</div>
              <select id="editTurn">
                <option value="">â€”</option>
                <option value="å…ˆæ‰‹">å…ˆæ‰‹</option>
                <option value="å¾Œæ‰‹">å¾Œæ‰‹</option>
              </select>
            </div>
          </div>

          <div class="twoCol">
            <div class="row">
              <div class="cap">è‡ªåˆ†ãƒ¡ã‚¬ãƒŸ</div>
              <input id="editMy1" list="wordList" placeholder="ä¾‹ï¼šãƒ¦ãƒªãƒŠ">
              <input id="editMy2" list="wordList" placeholder="ä¾‹ï¼šã‚µã‚¤ãƒ">
            </div>

            <div class="row">
              <div class="cap">ç›¸æ‰‹ãƒ¡ã‚¬ãƒŸ</div>
              <input id="editTheir1" list="wordList" placeholder="ä¾‹ï¼šãƒ’ãƒŸã‚«">
              <input id="editTheir2" list="wordList" placeholder="ä¾‹ï¼šãƒˆã‚³ãƒ¨">
            </div>
          </div>

          <div class="twoCol">
            <div class="row">
              <div class="cap">BANã•ã‚ŒãŸãƒ¡ã‚¬ãƒŸ</div>
              <input id="editMyBan" list="wordList" placeholder="ä¾‹ï¼šã‚ªãƒœãƒ­">
            </div>

            <div class="row">
              <div class="cap">BANã—ãŸãƒ¡ã‚¬ãƒŸ</div>
              <input id="editTheirBan" list="wordList" placeholder="ä¾‹ï¼šãƒ›ãƒã‚«">
            </div>
          </div>

          <div class="row">
            <div class="cap">ã‚¿ã‚°</div>
            <input id="editTag" placeholder="ä¾‹ï¼šãƒªãƒ¼ã‚µãƒ«æ€¥ã / é–“åˆãƒŸã‚¹">
          </div>

          <div class="row">
            <div class="cap">åçœç‚¹ï¼ˆä»»æ„ï¼‰</div>
            <textarea id="editPivot" placeholder="åçœç‚¹"></textarea>
          </div>

          <div class="row">
            <div class="cap">æ”¹å–„ç‚¹ï¼ˆä»»æ„ï¼‰</div>
            <textarea id="editNext" placeholder="æ”¹å–„ç‚¹"></textarea>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="ghost" type="button" id="editCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="primary" type="button" id="editSaveBtn">ä¿å­˜</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =========================
  ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰
  â€» list.htmlï¼ˆç®¡ç†å´ï¼‰ã«ã ã‘ç½®ã
========================= -->
<div id="dataModal" class="modal" aria-hidden="true">
  <div class="card inner">
    <div class="modalTop">
      <h3 class="modalTitle">ğŸ“¦ ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰</h3>
      <button class="ghost" type="button" id="closeData">é–‰ã˜ã‚‹</button>
    </div>

    <div class="helpBox">
      <h4 style="margin:0 0 6px;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆçµ±ä¸€JSONï¼‰</h4>
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <button class="ghost" type="button" id="exportDataBtn">ğŸ“¤ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <span class="mini">â€» localStorageã®è¨˜éŒ²ã‚’çµ±ä¸€JSONã«å¤‰æ›ã—ã¾ã™</span>
      </div>
    </div>

    <div class="helpBox" style="margin-top:10px;">
      <h4 style="margin:0 0 6px;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆçµ±ä¸€JSON / Bæ–¹å¼ï¼‰</h4>

      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <input type="file" id="importFile" accept="application/json,.json" />
        <button class="ghost" type="button" id="importRunBtn">ğŸ“¥ èª­ã¿è¾¼ã¿</button>
      </div>

      <div class="mini" id="importSummary" style="margin-top:10px;"></div>

      <!-- é‡è¤‡å€™è£œï¼ˆä¿ç•™ï¼‰è¡¨ç¤º -->
      <div id="dupArea" style="margin-top:10px;"></div>

      <div id="applyArea" style="display:none; margin-top:10px; justify-content:flex-end; gap:8px;">
        <button class="primary" type="button" id="applyResolvedBtn">ç¢ºå®šã—ã¦ä¿å­˜</button>
      </div>

      <div class="mini" style="margin-top:8px;">
        â€»é‡è¤‡å€™è£œã¯ä¿ç•™ã•ã‚Œã¾ã™ã€‚ã€Œæ—¢å­˜ã‚’æ®‹ã™ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’æ¡ç”¨ / ä¸¡æ–¹æ®‹ã™ã€ã‚’é¸ã‚“ã§ã‹ã‚‰ç¢ºå®šã—ã¾ã™ã€‚
      </div>
    </div>
  </div>
</div>

      <!-- ãƒ¡ã‚¬ãƒŸ/BAN å…±é€šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼è¾æ›¸ï¼ˆå€™è£œï¼‰ -->
      <datalist id="wordList"></datalist>

  <!-- â–¼ ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º -->
  <div class="versionBadge" id="versionBadge"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  //ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°
  const APP_VERSION = "1.1.0";

  function track(name, params={}){
    // gtag æœªãƒ­ãƒ¼ãƒ‰ã§ã‚‚å£Šã‚Œãªã„ã‚ˆã†ã«
    if(typeof window.gtag === "function"){
      window.gtag("event", name, params);
    }
  }

  // =========================================================
  //  iPhone/Safariå¯¾ç­–
  // =========================================================
  async function copyText(text){
    // 1) ã¾ãšã¯ Clipboard APIï¼ˆhttps / ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªã“ã¨ãŒå¤šã„ï¼‰
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return { ok:true, via:"clipboard" };
      }
    }catch(e){
      // å¤±æ•—ã—ãŸã‚‰ä¸‹ã¸
    }

    // 2) ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼štextareaã«å…¥ã‚Œã¦é¸æŠâ†’execCommand('copy')
    try{
      const ta = document.createElement("textarea");
      ta.value = text;

      // ç”»é¢ã«è¦‹ãˆãªã„ã‚ˆã†ã«ã—ã¤ã¤ã€é¸æŠå¯èƒ½ã«ã™ã‚‹
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      ta.style.opacity = "0";
      ta.setAttribute("readonly", "");

      document.body.appendChild(ta);

      // iOSã¯ selectionRange æŒ‡å®šãŒåŠ¹ãã“ã¨ãŒå¤šã„
      ta.focus();
      ta.select();
      ta.setSelectionRange(0, ta.value.length);

      const ok = document.execCommand("copy");
      document.body.removeChild(ta);

      if(ok) return { ok:true, via:"execCommand" };
    }catch(e){
      // ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ä¸‹ã¸
    }

   // 3) æœ€çµ‚ï¼šã‚³ãƒ”ãƒ¼æ¬„ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¦‹ã›ã¦æ‰‹å‹•ã‚³ãƒ”ãƒ¼ã—ã¦ã‚‚ã‚‰ã†
   showManualCopyModal(text);
   return { ok:false, via:"manual" };
  }

  // æ‰‹å‹•ã‚³ãƒ”ãƒ¼ç”¨ã®ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé•·æŠ¼ã—â†’ã‚³ãƒ”ãƒ¼ï¼‰
  function showManualCopyModal(text){
    // æ—¢ã«å‡ºã¦ãŸã‚‰å†åˆ©ç”¨
    let overlay = document.getElementById("manualCopyOverlay");
    let box = document.getElementById("manualCopyBox");

    if(!overlay){
      overlay = document.createElement("div");
      overlay.id = "manualCopyOverlay";
      overlay.style.position = "fixed";
      overlay.style.inset = "0";
      overlay.style.background = "rgba(0,0,0,.35)";
      overlay.style.zIndex = "2000";
      overlay.style.display = "flex";
      overlay.style.alignItems = "center";
      overlay.style.justifyContent = "center";
      overlay.style.padding = "14px";

      const card = document.createElement("div");
      card.style.maxWidth = "680px";
      card.style.width = "100%";
      card.style.background = "#fff";
      card.style.borderRadius = "16px";
      card.style.padding = "12px";
      card.style.boxShadow = "0 14px 38px rgba(0,0,0,.12)";

      const top = document.createElement("div");
      top.style.display = "flex";
      top.style.justifyContent = "space-between";
      top.style.alignItems = "center";
      top.style.gap = "10px";

      const title = document.createElement("div");
      title.textContent = "ã‚³ãƒ”ãƒ¼ã§ããªã‹ã£ãŸã®ã§æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ã­";
      title.style.fontWeight = "900";
      title.style.fontSize = "14px";

      const close = document.createElement("button");
      close.type = "button";
      close.textContent = "é–‰ã˜ã‚‹";
      close.style.border = "1px solid rgba(0,0,0,.15)";
      close.style.background = "#fff";
      close.style.borderRadius = "12px";
      close.style.padding = "8px 10px";
      close.style.cursor = "pointer";
      close.addEventListener("click", ()=> overlay.remove());

      top.appendChild(title);
      top.appendChild(close);

      box = document.createElement("textarea");
      box.id = "manualCopyBox";
      box.style.width = "100%";
      box.style.minHeight = "180px";
      box.style.marginTop = "10px";
      box.style.borderRadius = "12px";
      box.style.border = "1px solid rgba(0,0,0,.15)";
      box.style.padding = "10px";
      box.style.fontSize = "13px";
      box.style.lineHeight = "1.6";

      const hint = document.createElement("div");
      hint.textContent = "â€»é•·æŠ¼ã—â†’ã€Œã‚³ãƒ”ãƒ¼ã€ã§OK";
      hint.style.marginTop = "8px";
      hint.style.fontSize = "12px";
      hint.style.color = "rgba(0,0,0,.6)";

      card.appendChild(top);
      card.appendChild(box);
      card.appendChild(hint);

      overlay.appendChild(card);

      // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ãªã„ï¼ˆã‚ãªãŸã®æ–¹é‡ï¼‰
      // overlay.addEventListener("click", e=> { if(e.target===overlay) overlay.remove(); });

      document.body.appendChild(overlay);
    }

    box.value = text;

    // é–‹ã„ãŸç¬é–“ã«å…¨é¸æŠï¼ˆiOSã¯ã“ã‚Œã§é•·æŠ¼ã—ã—ã‚„ã™ã„ï¼‰
    setTimeout(()=>{
      box.focus();
      box.select();
      box.setSelectionRange(0, box.value.length);
    }, 50);
  }

  const DATA_KEY  = "furuyoni_match_logs_v1";
  const THEME_KEY = "furuyoni_theme_v1";
  const PER_PAGE  = 30;

  // =========================================================
  // 12) ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ / ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆçµ±ä¸€JSONï¼‰
  // =========================================================
  const DEFAULT_VISIBILITY = "public"; // ä»Šã¯UIãŒç„¡ã„ã®ã§å›ºå®š

  function newUid(){
    if(crypto?.randomUUID) return crypto.randomUUID();
    return "uid_" + Date.now() + "_" + Math.random().toString(36).slice(2,10);
  }

  // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã« uid ãŒç„¡ã‘ã‚Œã°ä»˜ä¸ï¼ˆæ°¸ç¶šåŒ–ï¼‰
  function ensureUids(){
    const rows = loadRows();
    let changed = false;
    for(const r of rows){
      if(!r.uid){
        r.uid = newUid();
        changed = true;
      }
    }
    if(changed) saveRows(rows);
    return rows;
  }

  // turn: å†…éƒ¨ï¼ˆå…ˆæ‰‹/å¾Œæ‰‹ï¼‰ â‡„ çµ±ä¸€ï¼ˆfirst/secondï¼‰
  function toUnifiedTurn(v){
    if(v === "å…ˆæ‰‹") return "first";
    if(v === "å¾Œæ‰‹") return "second";
    return null;
  }
  function fromUnifiedTurn(v){
    if(v === "first") return "å…ˆæ‰‹";
    if(v === "second") return "å¾Œæ‰‹";
    return "";
  }

  // ts: "YYYY-MM-DD HH:mm" â†’ created_at: "YYYY-MM-DDTHH:mm:00+09:00"
  function toIsoFromTs(ts){
    if(!ts) return null;
    const m = ts.match(/^(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2})$/);
    if(!m) return null;
    return `${m[1]}T${m[2]}:00+09:00`;
  }
  function toDateFromTs(ts){
    const d = (ts || "").slice(0,10);
    return /^\d{4}-\d{2}-\d{2}$/.test(d) ? d : null;
  }

  // å†…éƒ¨ row â†’ çµ±ä¸€JSON
  function rowToUnified(r){
    return {
      id: r.uid || newUid(),
      created_at: toIsoFromTs(r.ts) || (new Date()).toISOString(),
      date: toDateFromTs(r.ts),

      result: r.result, // WIN/LOSE

      // ã“ã“ã¯ä»Šã®é‹ç”¨ã«åˆã‚ã›ã¦ã€Œæ–‡å­—åˆ—ã®ã¾ã¾ã€å‡ºã—ã¾ã™
      my1: r.my1 || null,
      my2: r.my2 || null,
      their1: r.their1 || null,
      their2: r.their2 || null,

      my_ban: r.myBan || null,
      their_ban: r.theirBan || null,

      match_type: r.matchType || null, // tournament/free/rank
      turn: toUnifiedTurn(r.turn),

      tag: r.tag || null,
      pivot: r.pivot || null,
      next: r.next || null,

      visibility: DEFAULT_VISIBILITY,
    };
  }

  // çµ±ä¸€JSON â†’ å†…éƒ¨ row
  function unifiedToRow(u){
    // created_at ãŒã‚ã‚Œã° ts ã«å¯„ã›ã‚‹
    let ts = null;
    if(typeof u.created_at === "string"){
      const v = u.created_at.replace("Z","+00:00");
      // "YYYY-MM-DDTHH:mm" ã¾ã§ã‚’ "YYYY-MM-DD HH:mm" ã«
      const head = v.slice(0,16);
      const cand = head.replace("T"," ");
      if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(cand)) ts = cand;
    }
    if(!ts){
      ts = (u.date || todayKey()) + " 00:00";
    }

    // æ—¢å­˜UIã®ã‚½ãƒ¼ãƒˆï¼ˆb.id-a.idï¼‰ç¶­æŒã®ãŸã‚ã€æ•°å€¤idã¯åˆ¥ã§ä½œã‚‹
    return {
      id: Date.now() + Math.floor(Math.random()*1000),
      uid: String(u.id || newUid()),

      ts,
      opponent: "",

      result: u.result === "WIN" ? "WIN" : "LOSE",

      my1: u.my1 || "",
      my2: u.my2 || "",
      their1: u.their1 || "",
      their2: u.their2 || "",
      myBan: u.my_ban || "",
      theirBan: u.their_ban || "",

      turn: fromUnifiedTurn(u.turn),
      matchType: u.match_type || "",

      tag: u.tag || "",
      pivot: u.pivot || "",
      next: u.next || "",
    };
  }

  // é‡è¤‡å€™è£œåˆ¤å®šç”¨ï¼šå¼·ã‚ä¸€è‡´ï¼ˆèª¤çˆ†ã—ã«ãã„ï¼‰
  function norm(s){ return String(s||"").trim().normalize("NFKC"); }
  function sortPair(a,b){
    const x = norm(a), y = norm(b);
    return [x,y].sort((p,q)=>p.localeCompare(q,"ja"));
  }
  function signatureFromRow(r){
    const date = (r.ts || "").slice(0,10);
    const [myA,myB] = sortPair(r.my1, r.my2);
    const [thA,thB] = sortPair(r.their1, r.their2);
    return [
      date,
      r.result || "",
      r.matchType || "",
      toUnifiedTurn(r.turn) || "",
      myA,myB,thA,thB
    ].join("|");
  }
  function signatureFromUnified(u){
    const date = norm(u.date);
    const [myA,myB] = sortPair(u.my1, u.my2);
    const [thA,thB] = sortPair(u.their1, u.their2);
    return [
      date,
      u.result || "",
      u.match_type || "",
      (u.turn || ""),
      myA,myB,thA,thB
    ].join("|");
  }

  // import state
  let pendingDups = [];     // { existingIndex, existingRow, importedRow, choice }
  let pendingAdds = [];     // row[]
  let pendingUpdates = [];  // { index, row }[]
  let lastImportStats = null;

  function classifyImport(unifiedList){
    const rows = ensureUids();

    const uidToIndex = new Map();
    rows.forEach((r,i)=> uidToIndex.set(String(r.uid), i));

    const sigToIndices = new Map();
    rows.forEach((r,i)=>{
      const sig = signatureFromRow(r);
      if(!sigToIndices.has(sig)) sigToIndices.set(sig, []);
      sigToIndices.get(sig).push(i);
    });

    pendingDups = [];
    pendingAdds = [];
    pendingUpdates = [];

    for(const u of unifiedList){
      const uid = String(u?.id || "");
      const sig = signatureFromUnified(u);

      // 1) åŒã˜uid â†’ æ›´æ–°ï¼ˆå³ä¸Šæ›¸ãå€™è£œï¼‰
      if(uid && uidToIndex.has(uid)){
        const idx = uidToIndex.get(uid);
        const newRow = unifiedToRow(u);
        // UIç”¨ã®æ•°å€¤idã¯ä¿æŒ
        newRow.id = rows[idx].id;
        // uidã‚‚ä¿æŒï¼ˆåŒã˜ï¼‰
        newRow.uid = rows[idx].uid;
        pendingUpdates.push({ index: idx, row: { ...rows[idx], ...newRow }});
        continue;
      }

      // 2) uidã¯é•ã†ãŒç½²åä¸€è‡´ â†’ é‡è¤‡å€™è£œã¨ã—ã¦ä¿ç•™
      const hit = sigToIndices.get(sig);
      if(hit && hit.length){
        const existingIndex = hit[0];
        const importedRow = unifiedToRow(u);

        pendingDups.push({
          existingIndex,
          existingRow: rows[existingIndex],
          importedRow,
          // åˆæœŸã¯å®‰å…¨å´
          choice: "keep_existing" // keep_existing / take_import / keep_both
        });
        continue;
      }

      // 3) ãã‚Œä»¥å¤– â†’ è¿½åŠ 
      pendingAdds.push(unifiedToRow(u));
    }

    lastImportStats = {
      total: unifiedList.length,
      adds: pendingAdds.length,
      updates: pendingUpdates.length,
      dups: pendingDups.length,
    };
  }

  function rowLabel(r){
    const date = (r.ts||"").slice(0,10);
    const res = r.result === "WIN" ? "å‹ã¡" : "è² ã‘";
    const mt = matchTypeText(r.matchType);
    const turn = r.turn || "â€”";
    return `${date} / ${res} / ${mt} / ${turn}\n${pairName(r.my1,r.my2)} vs ${pairName(r.their1,r.their2)}`;
  }

  function renderDupResolver(){
    const sum = $("importSummary");
    const dupArea = $("dupArea");
    const applyArea = $("applyArea");

    if(!lastImportStats){
      sum.textContent = "";
      dupArea.innerHTML = "";
      applyArea.style.display = "none";
      return;
    }

    sum.textContent =
      `èª­ã¿è¾¼ã¿ï¼š${lastImportStats.total}ä»¶ / è¿½åŠ ï¼š${lastImportStats.adds}ä»¶ / æ›´æ–°ï¼š${lastImportStats.updates}ä»¶ / é‡è¤‡å€™è£œï¼š${lastImportStats.dups}ä»¶`;

    applyArea.style.display = "flex";

    if(pendingDups.length === 0){
      dupArea.innerHTML = `<div class="mini">é‡è¤‡å€™è£œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
      return;
    }

    dupArea.innerHTML = pendingDups.map((d,i)=>{
      const a = rowLabel(d.existingRow);
      const b = rowLabel(d.importedRow);
      return `
        <div style="border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:12px;background:#fff;margin-top:10px;">
          <div class="cap">é‡è¤‡å€™è£œ ${i+1}</div>

          <div class="mini">ã€æ—¢å­˜ã€‘</div>
          <pre style="margin:6px 0 10px; white-space:pre-wrap;">${escapeHtml(a)}</pre>

          <div class="mini">ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€‘</div>
          <pre style="margin:6px 0 10px; white-space:pre-wrap;">${escapeHtml(b)}</pre>

          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <label class="mini"><input type="radio" name="dup_${i}" value="keep_existing" ${d.choice==="keep_existing"?"checked":""}> æ—¢å­˜ã‚’æ®‹ã™</label>
            <label class="mini"><input type="radio" name="dup_${i}" value="take_import" ${d.choice==="take_import"?"checked":""}> ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’æ¡ç”¨ï¼ˆæ—¢å­˜ç½®æ›ï¼‰</label>
            <label class="mini"><input type="radio" name="dup_${i}" value="keep_both" ${d.choice==="keep_both"?"checked":""}> ä¸¡æ–¹æ®‹ã™</label>
          </div>
        </div>
      `;
    }).join("");

    pendingDups.forEach((d,i)=>{
      dupArea.querySelectorAll(`input[name="dup_${i}"]`).forEach(el=>{
        el.addEventListener("change", ()=>{ d.choice = el.value; });
      });
    });
  }

  function applyImportResolved(){
    const rows = ensureUids();

    // 1) æ›´æ–°ï¼ˆuidä¸€è‡´ï¼‰
    for(const u of pendingUpdates){
      rows[u.index] = u.row;
    }

    // 2) é‡è¤‡å€™è£œï¼ˆBæ–¹å¼ï¼šä¿ç•™â†’é¸æŠï¼‰
    for(const d of pendingDups){
      if(d.choice === "keep_existing"){
        continue;
      }
      if(d.choice === "take_import"){
        // æ—¢å­˜ã®æ•°å€¤idã¨uidã‚’ä¿æŒï¼ˆåŒä¸€è©¦åˆã¨ã—ã¦â€œèº«å…ƒâ€ã‚’å¤‰ãˆãªã„ï¼‰
        const keepId  = rows[d.existingIndex].id;
        const keepUid = rows[d.existingIndex].uid;

        const replaced = { ...rows[d.existingIndex], ...d.importedRow };
        replaced.id = keepId;
        replaced.uid = keepUid;

        rows[d.existingIndex] = replaced;
        continue;
      }
      if(d.choice === "keep_both"){
        rows.push(d.importedRow);
        continue;
      }
    }

    // 3) è¿½åŠ 
    for(const a of pendingAdds){
      rows.push(a);
    }

    saveRows(rows);

    // cleanup
    pendingDups = [];
    pendingAdds = [];
    pendingUpdates = [];
    lastImportStats = null;

    render();
    alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ç¢ºå®šã—ã¾ã—ãŸï¼");
  }

  // ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ€ãƒ« open/close
  function openData(){
    $("dataModal").style.display = "flex";
    $("dataModal").setAttribute("aria-hidden","false");
    $("importSummary").textContent = "";
    $("dupArea").innerHTML = "";
    $("applyArea").style.display = "none";
    // file input ãƒªã‚»ãƒƒãƒˆ
    const f = $("importFile");
    if(f) f.value = "";
  }
  function closeData(){
    $("dataModal").style.display = "none";
    $("dataModal").setAttribute("aria-hidden","true");
  }
  $("openData").addEventListener("click", openData);
  $("closeData").addEventListener("click", closeData);

  // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼šçµ±ä¸€JSONï¼ˆé…åˆ—ï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  $("exportDataBtn").addEventListener("click", ()=>{
    const rows = ensureUids();
    const unified = rows.map(rowToUnified);
    const blob = new Blob([JSON.stringify(unified, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `tsumilog_export_${todayKey()}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼šåˆ†é¡â†’ï¼ˆé‡è¤‡å€™è£œã¯ä¿ç•™è¡¨ç¤ºï¼‰â†’ç¢ºå®š
  $("importRunBtn").addEventListener("click", async ()=>{
    const file = $("importFile")?.files?.[0];
    if(!file){
      alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­");
      return;
    }

    const text = await file.text();
    let data;
    try{ data = JSON.parse(text); }
    catch{ alert("JSONã¨ã—ã¦èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ"); return; }

    // é…åˆ— or {items:[...]} ä¸¡å¯¾å¿œ
    const list = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : null);
    if(!list){
      alert("å½¢å¼ãŒé•ã„ã¾ã™ï¼ˆçµ±ä¸€JSONã®é…åˆ—ã‚’å…¥ã‚Œã¦ã­ï¼‰");
      return;
    }

    classifyImport(list);
    renderDupResolver();

    // ç¢ºå®šãƒœã‚¿ãƒ³è¡¨ç¤º
    $("applyArea").style.display = "flex";
  });

  $("applyResolvedBtn").addEventListener("click", ()=>{
    applyImportResolved();
    closeData();
  });

  // =========================================================
  // 1.5) ãƒ¦ãƒ¼ã‚¶ãƒ¼è¾æ›¸ï¼ˆãƒ¡ã‚¬ãƒŸ/BAN çµ±ä¸€ï¼‰
  // =========================================================
  const DICT_KEY = "tsumilog_user_dict_v1";

  function loadDict(){
    try{
      const arr = JSON.parse(localStorage.getItem(DICT_KEY) || "[]");
      return Array.isArray(arr) ? arr : [];
    }catch{
      return [];
    }
  }
  function saveDict(list){
    localStorage.setItem(DICT_KEY, JSON.stringify(list));
  }
  function normText(s){
    return String(s||"").trim().replace(/\s+/g," ").normalize("NFKC");
  }
  function nextDictId(dict){
    const max = dict.reduce((m,x)=>Math.max(m, Number(x.id)||0), 0);
    return max + 1;
  }
  function upsertDict(text){
    const label = String(text||"").trim();
    const key = normText(label);
    if(!key) return null;

    const dict = loadDict();
    const hit = dict.find(x => x.key === key);
    if(hit) return hit;

    const item = { id: nextDictId(dict), key, label };
    dict.push(item);
    saveDict(dict);
    return item;
  }
  function renderWordDatalist(){
    const dl = document.getElementById("wordList");
    if(!dl) return;

    const dict = loadDict();
    dl.innerHTML = dict
      .slice()
      .sort((a,b)=>String(a.label).localeCompare(String(b.label),"ja"))
      .map(x => `<option value="${escapeHtml(x.label)}"></option>`)
      .join("");
  }

  /* =========================
    ãƒ†ãƒ¼ãƒåæ˜ ï¼ˆCSSå¤‰æ•°ã‚’æ›¸ãæ›ãˆã‚‹ï¼‰
  ========================= */
  const DEFAULT_THEME = {
    bg1: "rgba(14,165,233,.13)",
    bg2: "rgba(34,197,94,.10)",
    bgTop: "#f7fbff",
    bgBottom: "#f7fff9",
    text: "#1f2937",
    muted: "#6b7280",
    card: "rgba(255,255,255,.80)",
    stroke: "rgba(31,41,55,.14)",
    accent: "#ff7a2f",
    accent2: "#ffd2a8",
  };
  function loadTheme(){
    try{
      return { ...DEFAULT_THEME, ...(JSON.parse(localStorage.getItem(THEME_KEY) || "{}")) };
    }catch{
      return { ...DEFAULT_THEME };
    }
  }
  function applyTheme(theme){
    const r = document.documentElement.style;
    r.setProperty("--bg1", theme.bg1);
    r.setProperty("--bg2", theme.bg2);
    r.setProperty("--bgTop", theme.bgTop);
    r.setProperty("--bgBottom", theme.bgBottom);
    r.setProperty("--text", theme.text);
    r.setProperty("--muted", theme.muted);
    r.setProperty("--card", theme.card);
    r.setProperty("--stroke", theme.stroke);
    r.setProperty("--accent", theme.accent);
    r.setProperty("--accent2", theme.accent2);
  }
  applyTheme(loadTheme());

  /* =========================
    ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé–‹é–‰ï¼‰
  ========================= */
  function openHelp(){
    $("helpModal").style.display = "flex";
    $("helpModal").setAttribute("aria-hidden", "false");
  }
  function closeHelp(){
    $("helpModal").style.display = "none";
    $("helpModal").setAttribute("aria-hidden", "true");
  }
  $("openHelp").addEventListener("click", openHelp);
  $("closeHelp").addEventListener("click", closeHelp);

  /* =========================
    ãƒ‡ãƒ¼ã‚¿ï¼ˆlocalStorageï¼‰
  ========================= */
  function loadRows(){
    try{ return JSON.parse(localStorage.getItem(DATA_KEY) || "[]"); }
    catch{ return []; }
  }
  function saveRows(rows){
    localStorage.setItem(DATA_KEY, JSON.stringify(rows));
  }

  /* =========================
    æ—¥ä»˜ï¼ˆä»Šæ—¥ï¼‰
  ========================= */
  const pad2 = (n) => String(n).padStart(2, "0");
  function todayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }

  /* =========================
    è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  ========================= */
  const MATCH_TYPE_LABEL = {
    tournament: "å¤§ä¼š",
    free: "ãƒ•ãƒªãƒ—",
    rank: "ãƒ©ãƒ³ã‚¯",
  };
  function matchTypeText(v){
    return MATCH_TYPE_LABEL[v] || "â€”";
  }
  
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function pairName(a,b){
    const x=(a||"").trim(), y=(b||"").trim();
    if(x && y) return `${x}/${y}`;
    return x || y || "?";
  }
  function firstLine(text){
    const s = String(text || "").replace(/\r\n/g, "\n");
    const line = s.split("\n")[0] || "";
    const max = 60;
    return line.length > max ? line.slice(0, max) + "â€¦" : line;
  }
  function hasMoreLines(text){
    const s = String(text || "").replace(/\r\n/g, "\n");
    return s.includes("\n") && s.split("\n").some((ln, i) => i > 0 && ln.trim() !== "");
  }

  /* =========================
    ä»Šæ—¥ãƒãƒƒãƒ—ï¼ˆå‹æ•—ï¼‰
  ========================= */
  function summarizeToday(rows){
    const t = todayKey();
    const today = rows.filter(r => (r.ts||"").startsWith(t));
    const w = today.filter(r => r.result==="WIN").length;
    const l = today.filter(r => r.result==="LOSE").length;
    return {w,l};
  }

  /* =========================
    ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿é…åˆ—ï¼ˆè©³ç´°ã®å‰ã¸/æ¬¡ã¸åŸºæº–ï¼‰
  ========================= */
  let currentFiltered = [];
  let currentDetailIndex = -1;

  /* =========================
    ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ¤œç´¢/å‹æ•—/ä»Šæ—¥ï¼‰
  ========================= */
  function getFilteredRows(rows){
    const q = $("q").value.trim().toLowerCase();
    const f = $("filter").value;
    const tKey = todayKey();

    let filtered = rows.slice();

    if(f==="WIN") filtered = filtered.filter(r=>r.result==="WIN");
    if(f==="LOSE") filtered = filtered.filter(r=>r.result==="LOSE");
    if(f==="TODAY") filtered = filtered.filter(r=>(r.ts||"").startsWith(tKey));

    if(state.selectedType !== "ALL"){
      filtered = filtered.filter(r => (r.matchType || "") === state.selectedType);
    }

    if(q){
      filtered = filtered.filter(r=>{
        const hay = [
          r.opponent, r.my1, r.my2, r.their1, r.their2, r.turn, r.tag,
          r.pivot, r.next, r.ts, r.result, r.myBan, r.theirBan, r.matchType
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    filtered.sort((a,b)=>b.id-a.id);
    return filtered;
  }

  /* =========================
    ãƒšãƒ¼ã‚¸ãƒ³ã‚°
  ========================= */
  const TYPE_FILTER_KEY = "furuyoni_list_type_filter_v1";

  const state = {
    page: 1,
    perPage: 30,
    keyword: "",
    result: "ALL",
    selectedType: localStorage.getItem(TYPE_FILTER_KEY) || "ALL",
  };

  function clampPage(page, totalPages){
    if(totalPages<=0) return 1;
    return Math.min(Math.max(1,page), totalPages);
  }

  function renderPager(totalItems){
    const totalPages = Math.max(1, Math.ceil(totalItems / PER_PAGE));
    state.page = clampPage(state.page, totalPages);

    const start = totalItems===0 ? 0 : (state.page - 1) * PER_PAGE + 1;
    const end = Math.min(state.page * PER_PAGE, totalItems);

    const prevDisabled = state.page <= 1;
    const nextDisabled = state.page >= totalPages;

    const pages = [];
    const add = (p)=>{ if(!pages.includes(p)) pages.push(p); };
    add(1); add(totalPages);
    for(let p=state.page-2; p<=state.page+2; p++){
      if(p>=1 && p<=totalPages) add(p);
    }
    pages.sort((a,b)=>a-b);

    let pageHtml="", last=0;
    for(const p of pages){
      if(last && p-last>1) pageHtml += `<span class="mini">â€¦</span>`;
      const isCurrent = p===state.page;
      pageHtml += `<button type="button" data-page="${p}" ${isCurrent ? "disabled":""}>${p}</button>`;
      last=p;
    }

    $("pager").innerHTML = `
      <button type="button" data-nav="prev" ${prevDisabled ? "disabled":""}>â†</button>
      ${pageHtml}
      <button type="button" data-nav="next" ${nextDisabled ? "disabled":""}>â†’</button>
      <span class="mini">${totalItems===0 ? "0ä»¶" : `${start}-${end} / ${totalItems}ä»¶`}</span>
    `;

    $("pager").querySelectorAll("[data-page]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        state.page = Number(btn.getAttribute("data-page"));
        render();

        track("list_page_change", {
          page: state.page
        });
      });
    });
    $("pager").querySelectorAll("[data-nav]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const nav = btn.getAttribute("data-nav");
        if(nav==="prev") state.page -= 1;
        if(nav==="next") state.page += 1;
        render();

        track("list_page_change", {
          page: state.page,
          nav: nav
        });
      });
    });
  }

  /* =========================
    æœªä¿å­˜å¤‰æ›´ï¼ˆdirtyï¼‰åˆ¤å®š
    - ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®å†…å®¹ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåŒ–ã—ã¦æ¯”è¼ƒ
    - ã€Œå‰ã¸/æ¬¡ã¸ã€ã€Œé–‰ã˜ã‚‹ã€ã€Œè¡¨ç¤ºã«æˆ»ã‚‹ã€ã§ç¢ºèªã«ä½¿ã†
  ========================= */
  let lastEditSnapshot = null;

  function getEditSnapshot(){
    return {
      result: $("editResult").value,
      turn: $("editTurn").value,
      my1: $("editMy1").value.trim(),
      my2: $("editMy2").value.trim(),
      their1: $("editTheir1").value.trim(),
      their2: $("editTheir2").value.trim(),
      myBan: $("editMyBan").value.trim(),
      theirBan: $("editTheirBan").value.trim(),
      tag: $("editTag").value.trim(),
      pivot: $("editPivot").value.trim(),
      next: $("editNext").value.trim(),
      matchType: $("editMatchType").value,
    };
  }

  function snapshotEquals(a,b){
    return JSON.stringify(a) === JSON.stringify(b);
  }

  function isEditMode(){
    return $("detailEdit").style.display !== "none";
  }

  function isDirty(){
    if(!isEditMode()) return false;
    if(!lastEditSnapshot) return false;
    return !snapshotEquals(getEditSnapshot(), lastEditSnapshot);
  }

  function confirmDiscardIfDirty(message){
    if(!isDirty()) return true;
    return confirm(message || "æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚\nä¿å­˜ã›ãšã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ");
  }

  /* =========================
    è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šè¡¨ç¤º/ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
  ========================= */
  function setEditMode(on){
    $("detailView").style.display = on ? "none" : "block";
    $("detailEdit").style.display = on ? "block" : "none";
    $("detailEditBtn").textContent = on ? "è¡¨ç¤ºã«æˆ»ã‚‹" : "ç·¨é›†";
  }

  function fillEditForm(r){
    $("editResult").value = r.result || "WIN";
    $("editTurn").value = r.turn || "";
    $("editMy1").value = r.my1 || "";
    $("editMy2").value = r.my2 || "";
    $("editTheir1").value = r.their1 || "";
    $("editTheir2").value = r.their2 || "";
    $("editMyBan").value = r.myBan || "";
    $("editTheirBan").value = r.theirBan || "";
    $("editTag").value = r.tag || "";
    $("editPivot").value = r.pivot || "";
    $("editNext").value = r.next || "";
    $("editMatchType").value = r.matchType || "";

    // â˜…ã“ã®æ™‚ç‚¹ï¼ˆèª­ã¿è¾¼ã‚“ã ç›´å¾Œï¼‰ã‚’ã€Œä¿å­˜æ¸ˆã¿ã®åŸºæº–ã€ã«ã™ã‚‹
    lastEditSnapshot = getEditSnapshot();
  }

  function openDetailByIndex(idx){
    if(idx < 0 || idx >= currentFiltered.length) return;

    currentDetailIndex = idx;
    const r = currentFiltered[idx];

    // ã‚¿ã‚°/å‹æ•—/æ—¥æ™‚ãªã©ã‚’ä¸Šéƒ¨ãƒãƒƒã‚¸ã§è¡¨ç¤º
    const badges = [];
    badges.push(`<span class="badge">ğŸ•’ ${escapeHtml(r.ts || "")}</span>`);

    const resText = r.result === "WIN" ? "å‹ã¡" : "è² ã‘";
    const resClass = r.result === "WIN" ? "badge winBadge" : "badge loseBadge";
    badges.push(`<span class="${resClass}">â— ${escapeHtml(resText)}</span>`);

    const mt = matchTypeText(r.matchType);
    if(mt !== "â€”") badges.push(`<span class="badge">ğŸ“Œ ${escapeHtml(mt)}</span>`);
    if(r.turn) badges.push(`<span class="badge">${escapeHtml(r.turn)}</span>`);
    if(r.tag)  badges.push(`<span class="badge tagBadge">#${escapeHtml(r.tag)}</span>`);

    $("detailMeta").innerHTML = badges.join(" ");

    // ç›¸æ‰‹ã¯è¡¨ç¤ºã—ãªã„ï¼ˆåŸºæœ¬æƒ…å ±ã‹ã‚‰å‰Šé™¤ï¼‰
    const baseLines = [];
    baseLines.push(`ä½¿ç”¨ï¼š${pairName(r.my1,r.my2)} vs ${pairName(r.their1,r.their2)}`);
    baseLines.push(`å‹æ•—ï¼š${resText}`);
    baseLines.push(`åŒºåˆ†ï¼š${mt}`);
    baseLines.push(`å…ˆå¾Œï¼š${r.turn || "â€”"}`);
    $("detailBase").textContent = baseLines.join("\n");

    $("detailBan").textContent = `è‡ªåˆ†ï¼š${r.myBan || "â€”"} / ç›¸æ‰‹ï¼š${r.theirBan || "â€”"}`;
    $("detailPivot").textContent = r.pivot || "â€”";
    $("detailNext").textContent = r.next || "â€”";

    // ãƒŠãƒ“
    $("prevBtn").disabled = (idx <= 0);
    $("nextBtn").disabled = (idx >= currentFiltered.length - 1);

    // ç·¨é›†æ¬„ã«åæ˜ 
    fillEditForm(r);

    // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
    setEditMode(false);

    $("detailModal").style.display = "flex";
    $("detailModal").setAttribute("aria-hidden", "false");

    track("log_open_detail", {
      source: "list",
      result: r.result,
      match_type: r.matchType || "none"
    });
  }

  function openDetailById(id){
    const idx = currentFiltered.findIndex(r => r.id === id);
    if(idx < 0) return;
    openDetailByIndex(idx);
  }

  function closeDetail(){
    if(!confirmDiscardIfDirty("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚\né–‰ã˜ã¦ã‚‚ã„ã„ã§ã™ã‹ï¼Ÿ")) return;

    $("detailModal").style.display = "none";
    $("detailModal").setAttribute("aria-hidden", "true");
    currentDetailIndex = -1;
    setEditMode(false);
  }

  $("closeDetail").addEventListener("click", closeDetail);

  // å‰ã¸/æ¬¡ã¸ï¼ˆæœªä¿å­˜ãªã‚‰ç¢ºèªï¼‰
  $("prevBtn").addEventListener("click", ()=>{
    if(!confirmDiscardIfDirty("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚\nä¿å­˜ã›ãšã«å‰ã®è©¦åˆã¸ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ")) return;
    openDetailByIndex(currentDetailIndex - 1);
  });

  $("nextBtn").addEventListener("click", ()=>{
    if(!confirmDiscardIfDirty("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚\nä¿å­˜ã›ãšã«æ¬¡ã®è©¦åˆã¸ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ")) return;
    openDetailByIndex(currentDetailIndex + 1);
  });

  // ç·¨é›†ãƒˆã‚°ãƒ«ï¼ˆç·¨é›†â†’è¡¨ç¤ºã«æˆ»ã‚‹æ™‚ã«æœªä¿å­˜ç¢ºèªï¼‰
  $("detailEditBtn").addEventListener("click", ()=>{
    const isEdit = isEditMode();

    if(isEdit){
      // ç·¨é›†â†’è¡¨ç¤ºã¸æˆ»ã‚‹
      if(!confirmDiscardIfDirty("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚\nè¡¨ç¤ºã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;
      setEditMode(false);
      // è¡¨ç¤ºã«æˆ»ã‚‹æ™‚ã¯ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’â€œå…ƒã®çŠ¶æ…‹â€ã«æˆ»ã—ã¦ãŠãï¼ˆæ°—æŒã¡ã‚ˆãï¼‰
      if(currentDetailIndex >= 0) fillEditForm(currentFiltered[currentDetailIndex]);
      return;
    }

    // è¡¨ç¤ºâ†’ç·¨é›†ã¸
    setEditMode(true);
    track("log_edit_start", {
      match_type: currentFiltered[currentDetailIndex]?.matchType || "none"
    });

    // â˜…ç·¨é›†é–‹å§‹æ™‚ç‚¹ã‚’åŸºæº–ã«ã™ã‚‹ï¼ˆã“ã“ã‹ã‚‰ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã—ãŸã„ï¼‰
    lastEditSnapshot = getEditSnapshot();
  });

  // ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆæœªä¿å­˜ãªã‚‰ç¢ºèªâ†’OKãªã‚‰å…ƒã«æˆ»ã™ï¼‰
  $("editCancelBtn").addEventListener("click", ()=>{
    if(!confirmDiscardIfDirty("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚\nã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ")) return;
    if(currentDetailIndex < 0) return;
    fillEditForm(currentFiltered[currentDetailIndex]);
    setEditMode(false);
  });

  // ç·¨é›†ä¿å­˜
  $("editSaveBtn").addEventListener("click", ()=>{
    if(currentDetailIndex < 0) return;

    const original = currentFiltered[currentDetailIndex];
    const id = original.id;

    const updated = {
      ...original,
      result: $("editResult").value,
      turn: $("editTurn").value,
      my1: $("editMy1").value.trim(),
      my2: $("editMy2").value.trim(),
      their1: $("editTheir1").value.trim(),
      their2: $("editTheir2").value.trim(),
      myBan: $("editMyBan").value.trim(),
      theirBan: $("editTheirBan").value.trim(),
      tag: $("editTag").value.trim(),
      pivot: $("editPivot").value.trim(),
      next: $("editNext").value.trim(),
      matchType: $("editMatchType").value,
    };

  /* =========================
    è¾æ›¸IDæ›´æ–°
  ========================= */
    // è¾æ›¸ã«çµ±ä¸€ç™»éŒ²ï¼ˆåŒã˜æ–‡å­—åˆ—ãªã‚‰åŒã˜IDï¼‰
    const my1Item = upsertDict(updated.my1);
    const my2Item = upsertDict(updated.my2);
    const their1Item = upsertDict(updated.their1);
    const their2Item = upsertDict(updated.their2);
    const myBanItem = upsertDict(updated.myBan);
    const theirBanItem = upsertDict(updated.theirBan);

    // IDã‚‚æ›´æ–°ã—ã¦ä¿å­˜ï¼ˆè¡¨ç¤ºã¯æ–‡å­—åˆ—ã®ã¾ã¾ï¼‰
    updated.my1Id = my1Item?.id ?? null;
    updated.my2Id = my2Item?.id ?? null;
    updated.their1Id = their1Item?.id ?? null;
    updated.their2Id = their2Item?.id ?? null;
    updated.myBanId = myBanItem?.id ?? null;
    updated.theirBanId = theirBanItem?.id ?? null;

    // datalistæ›´æ–°
    renderWordDatalist();

    // æœ€ä½é™ã®å¿…é ˆ
    if(!updated.my1 || !updated.my2 || !updated.their1 || !updated.their2){
      alert("å¿…é ˆï¼šè‡ªåˆ†ãƒ¡ã‚¬ãƒŸ2 / ç›¸æ‰‹ãƒ¡ã‚¬ãƒŸ2 ã‚’åŸ‹ã‚ã¦ã­");
      return;
    }

    // å…¨ä½“ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    const rows = loadRows();
    const idxAll = rows.findIndex(r => r.id === id);
    if(idxAll < 0){
      alert("ä¿å­˜å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆä¸€è¦§ã‚’æ›´æ–°ã—ã¦å†åº¦è©¦ã—ã¦ã­ï¼‰");
      return;
    }
    rows[idxAll] = updated;
    saveRows(rows);

    track("log_edit_save", {
      result: updated.result,
      match_type: updated.matchType || "none"
    });

    // ä¿å­˜å¾Œã¯ã€Œæ±šã‚Œã¦ã„ãªã„çŠ¶æ…‹ã€ã«ã™ã‚‹
    lastEditSnapshot = getEditSnapshot();

    // ç”»é¢æ›´æ–°ï¼ˆfilteredå†æ§‹ç¯‰â†’åŒã˜IDã‚’é–‹ãç›´ã™ï¼‰
    render();

    // æ–°ã—ã„filteredã®ä¸­ã§åŒã˜IDã‚’æ¢ã—ã¦é–‹ãç›´ã™
    const newIdx = currentFiltered.findIndex(r => r.id === id);
    if(newIdx >= 0) openDetailByIndex(newIdx);
    else closeDetail(); // ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã§æ¶ˆãˆãŸå ´åˆ
  });

  // 1ä»¶å‰Šé™¤ï¼ˆå…±é€šï¼‰
  function deleteOneById(id){
    const rows = loadRows();
    const idx = rows.findIndex(r => r.id === id);
    if(idx < 0) return false;
    rows.splice(idx, 1);
    saveRows(rows);
    return true;
  }

  // è©³ç´°ï¼šå‰Šé™¤
  $("detailDeleteBtn").addEventListener("click", ()=>{
    if(currentDetailIndex < 0) return;
    const r = currentFiltered[currentDetailIndex];

    const ok = confirm(
      `ã“ã®1ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n` +
      `å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\n` +
      `ã€${r.ts}ã€‘${pairName(r.my1,r.my2)} vs ${pairName(r.their1,r.their2)}\n` +
      `æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`
    );
    if(!ok) return;

    deleteOneById(r.id);

    track("log_delete", {
      source: "detail",
      result: r.result,
      match_type: r.matchType || "none"
    });

    closeDetail();
    render();
  });

  /* =========================
    ä¸€è¦§æç”»ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼è©³ç´°ã€ãƒœã‚¿ãƒ³ï¼ç·¨é›†/å‰Šé™¤ï¼‰
  ========================= */
  function renderList(rows){
    const filtered = getFilteredRows(rows);
    currentFiltered = filtered;

    const total = filtered.length;
    renderPager(total);

    if(total===0){
      $("listArea").innerHTML = `<div class="empty">è©²å½“ãªã—</div>`;
      return;
    }

    const totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
    state.page = clampPage(state.page, totalPages);

    const startIdx = (state.page - 1) * PER_PAGE;
    const pageRows = filtered.slice(startIdx, startIdx + PER_PAGE);

    let html = `<table><tbody>`;
    for(const r of pageRows){
      const res = r.result==="WIN" ? "å‹ã¡" : "è² ã‘";
      const mark = r.result==="WIN" ? "â—" : "Ã—";
      const myTeam = pairName(r.my1,r.my2);
      const theirTeam = pairName(r.their1,r.their2);
      const mt = matchTypeText(r.matchType);

      const pivot1 = firstLine(r.pivot);
      const ellipsis = hasMoreLines(r.pivot) ? " â€¦" : "";

      html += `
        <tr>
          <td style="width:92px">
            <span class="mini">${escapeHtml((r.ts||"").slice(11))}</span><br>
            <b>${mark} ${res}</b>
          </td>
          <td>
            <span class="linklike" data-open="${r.id}">${escapeHtml(myTeam)} vs ${escapeHtml(theirTeam)}</span>
            <span class="mini">ã€€[${escapeHtml(mt)}]</span>
            ${r.tag ? `<span class="mini">ã€€#${escapeHtml(r.tag)}</span>` : ""}
            <div class="mini">BANï¼šè‡ªåˆ† ${escapeHtml(r.myBan||"â€”")} / ç›¸æ‰‹ ${escapeHtml(r.theirBan||"â€”")}</div>
            <div class="mini">åçœï¼š${escapeHtml(pivot1)}${ellipsis}</div>
          </td>
          <td style="width:150px">
            <div class="actions">
              <button class="ghost miniBtn" type="button" data-edit="${r.id}">ç·¨é›†</button>
              <button class="dangerBtn miniBtn" type="button" data-del="${r.id}">å‰Šé™¤</button>
            </div>
          </td>
        </tr>
      `;
    }
    html += `</tbody></table>`;
    $("listArea").innerHTML = html;

    // è©³ç´°ã‚’é–‹ã
    document.querySelectorAll("[data-open]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const id = Number(el.getAttribute("data-open"));
        openDetailById(id);
      });
    });

    // ä¸€è¦§ï¼šç·¨é›†ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§é–‹ãï¼‰â€»ç·¨é›†é–‹å§‹æ™‚ã‚’ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆåŸºæº–ã«
    document.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = Number(btn.getAttribute("data-edit"));
        openDetailById(id);
        setTimeout(()=>{
          setEditMode(true);
          lastEditSnapshot = getEditSnapshot(); // â˜…ç·¨é›†é–‹å§‹ã‚’åŸºæº–ã«ã™ã‚‹
        }, 0);
      });
    });

    // ä¸€è¦§ï¼šå‰Šé™¤
    document.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = Number(btn.getAttribute("data-del"));
        const r = currentFiltered.find(x=>x.id===id);
        if(!r) return;

        const ok = confirm(
          `ã“ã®1ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nå–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\n` +
          `ã€${r.ts}ã€‘${pairName(r.my1,r.my2)} vs ${pairName(r.their1,r.their2)}\n` +
          `æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`
        );
        if(!ok) return;

        deleteOneById(id);

        track("log_delete", {
          source: "list",
          match_type: r.matchType || "none"
        });

        render();
      });
    });
  }

  function render(){
    renderWordDatalist();
    const rows = loadRows();
    $("countChip").textContent = `${rows.length}ä»¶`;
    const t = summarizeToday(rows);
    $("todayChip").textContent = `ä»Šæ—¥ï¼š${t.w}å‹${t.l}æ•—`;
    renderList(rows);
  }

  /* =========================
    ã‚¤ãƒ™ãƒ³ãƒˆ
  ========================= */
  let qTimer = null;

  $("q").addEventListener("input", ()=>{
    state.page = 1;
    render();

    clearTimeout(qTimer);
    qTimer = setTimeout(()=>{
      track("list_search", {
        has_query: !!$("q").value.trim(),
        result_filter: $("filter").value,
        type_filter: $("typeFilter").value
      });
    }, 500);
  });

  $("filter").addEventListener("change", ()=>{
    state.page = 1;
    render();

    track("list_filter_change", {
      result_filter: $("filter").value,
      type_filter: $("typeFilter").value
    });
  });

  $("typeFilter").addEventListener("change", ()=>{
    state.selectedType = $("typeFilter").value;
    localStorage.setItem(TYPE_FILTER_KEY, state.selectedType);
    state.page = 1;
    render();

    track("list_filter_change", {
      result_filter: $("filter").value,
      type_filter: state.selectedType
    });
  });

  $("typeFilter").value = state.selectedType;

    const vb = $("versionBadge");
    if(vb) vb.textContent = `v${APP_VERSION}`;

  // åˆæœŸåŒ–
  render();
})();
</script>
</body>
</html>